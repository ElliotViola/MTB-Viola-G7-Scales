<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elliot's Scale Practice App for MTB Viola Exams</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN for audio synthesis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Font Awesome for the help icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            flex-direction: column; /* Changed to column to stack main container and new button */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 700px; /* Slightly wider to accommodate the list better */
            width: 100%;
            text-align: center;
            position: relative; /* Needed for absolute positioning of help icon */
        }
        .scale-display {
            min-height: 80px; /* Ensure enough space for text */
        }
        .greyed-out {
            opacity: 0.5;
            text-decoration: line-through;
            color: #6b7280; /* Tailwind gray-500 */
        }
        .clickable-scale-item {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .clickable-scale-item:hover {
            background-color: #e2e8f0; /* Tailwind gray-200 */
        }
        /* Custom scrollbar for the scales list */
        .scales-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .scales-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scales-list-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Tailwind gray-300 */
            border-radius: 10px;
        }
        .scales-list-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Tailwind gray-400 */
        }

        /* Star rating styles */
        .star-rating .star {
            cursor: pointer;
            font-size: 2.5rem; /* Larger stars */
            color: #ccc; /* Default grey */
            transition: color 0.2s ease-in-out, transform 0.1s ease-in-out;
            display: inline-block; /* Allow horizontal alignment */
            margin: 0 0.2rem; /* Space between stars */
        }
        .star-rating .star:hover {
            transform: scale(1.1);
        }
        .star-rating .star.selected {
            color: #facc15; /* Tailwind amber-400 */
        }
        .star-rating .star.hovered {
            color: #facc15; /* Tailwind amber-400 */
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2.5rem;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.25);
            text-align: center;
            max-width: 90%;
            width: 500px; /* Wider for the list */
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .category-heading {
            font-weight: bold;
            color: #2d3748; /* Tailwind gray-800 */
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 1.5rem; /* Larger heading */
            border-bottom: 2px solid #a0aec0; /* Tailwind gray-400 */
            padding-bottom: 0.5rem;
            text-align: left;
        }

        /* Help icon specific styling */
        #helpIcon {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            font-size: 1.8rem; /* Slightly larger icon */
            color: #4a5568; /* Tailwind gray-700 */
            cursor: pointer;
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
            z-index: 10; /* Ensure it's above other content in the container */
        }
        #helpIcon:hover {
            color: #2d3748; /* Darker gray on hover */
            transform: scale(1.1);
        }
        /* Help modal content scrolling */
        #helpModalContent {
            max-height: 70vh; /* Max height before scrolling */
            overflow-y: auto; /* Enable vertical scrolling */
            text-align: left; /* Align text within the help content */
            padding-right: 1rem; /* Add padding for scrollbar */
        }
         #helpModalContent::-webkit-scrollbar {
            width: 8px;
        }
        #helpModalContent::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #helpModalContent::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        #helpModalContent::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="selection:bg-cyan-200">
    <div class="container flex flex-col items-center justify-center p-6 sm:p-8 md:p-10">
        <h1 id="mainTitle" class="text-3xl sm:text-4xl font-bold text-gray-800 mb-6">Elliot's Scale Practice App for MTB Viola Exams</h1>

        <!-- Help Icon -->
        <i id="helpIcon" class="fas fa-question-circle"></i>

        <!-- Grade Selection Screen -->
        <div id="gradeSelectionScreen" class="w-full flex flex-col items-center justify-center">
            <p class="text-lg text-gray-600 mb-8">Select the exam grade you're working towards:</p>
            <div id="gradeButtonsContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-4 w-full max-w-lg">
                <!-- Grade buttons will be inserted here by JavaScript -->
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practiceScreen" class="w-full hidden flex-col items-center justify-center">
            <p class="text-lg text-gray-600 mb-8">Click the button below to get a random scale or arpeggio to practice!</p>

            <div id="scaleDisplay" class="scale-display text-4xl sm:text-5xl font-extrabold text-teal-600 mb-10 flex items-center justify-center min-h-[100px] text-center p-4 bg-teal-50 rounded-lg shadow-inner w-full break-words leading-tight">
                Your next challenge awaits!
            </div>

            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-10 w-full max-w-xs">
                <button id="gimmeScaleButton" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-teal-300 focus:ring-opacity-75 text-xl sm:text-2xl w-full">
                    Gimme a Scale!
                </button>
                <button id="togglePracticeModeButton" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-6 rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:-translate-y-1 focus:outline-none focus:ring-4 focus://ring-purple-300 focus:ring-opacity-75 text-lg sm:text-xl w-full">
                    Toggle Practice Mode
                </button>
            </div>

            <!-- BPM Slider -->
            <div class="w-full max-w-md flex flex-col items-center justify-center mb-6">
                <label for="bpmSlider" class="text-lg font-semibold text-gray-700 mb-2">
                    Playback Speed: <span id="bpmValueDisplay">50</span> BPM (crotchet)
                </label>
                <input type="range" id="bpmSlider" min="30" max="120" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
            </div>

            <!-- Volume Slider -->
            <div class="w-full max-w-md flex flex-col items-center justify-center mb-10">
                <label for="volumeSlider" class="text-lg font-semibold text-gray-700 mb-2">
                    Volume: <span id="volumeValueDisplay">100</span>%
                </label>
                <input type="range" id="volumeSlider" min="0" max="100" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
            </div>

            <!-- Container for Demonstration Button and Star Rating -->
            <div id="actionContainer" class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-10 hidden">
                <button id="demonstrationButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-75 text-lg sm:text-xl">
                    Play Demo
                </button>
                <div id="starRatingContainer" class="star-rating">
                    <span class="star" data-value="1">&#9733;</span>
                    <span class="star" data-value="2">&#9733;</span>
                    <span class="star" data-value="3">&#9733;</span>
                    <span class="star" data-value="4">&#9733;</span>
                    <span class="star" data-value="5">&#9733;</span>
                    <p class="text-gray-500 text-sm mt-2">Rate how well you played (1=Hardest, 5=Easiest)</p>
                </div>
            </div>

            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mt-10 mb-4">All Scales & Arpeggios</h2>
            <div id="allScalesList" class="scales-list-container grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4 p-4 bg-gray-50 rounded-lg shadow-inner w-full max-h-60 overflow-y-auto">
                <!-- Scale items will be dynamically inserted here by JavaScript -->
            </div>
            <button id="backToGradesButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 ease-in-out mt-8">
                Back to Grades
            </button>
        </div>
    </div>

    <!-- "Made by Elliot Corner" Button -->
    <a href="http://www.elliotviola.co.uk/" target="_blank" rel="noopener noreferrer"
       class="mt-8 px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-full shadow-lg
              hover:from-blue-600 hover:to-indigo-700 transition duration-300 ease-in-out transform hover:scale-105
              focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-75 text-lg flex items-center justify-center">
        Made by Elliot Corner
    </a>


    <!-- Congratulations Modal -->
    <div id="congratulationsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-3xl font-bold text-teal-600 mb-4">Congratulations!</h3>
            <p class="text-xl text-gray-700 mb-6">Well done! You've completed a round of scales. Here's what to practise next!</p>
            <h4 class="text-lg font-semibold text-gray-800 mb-2">Scales Ordered by Difficulty (Hardest to Easiest):</h4>
            <div id="modalScalesList" class="text-left text-gray-700 max-h-40 overflow-y-auto mb-6 p-2 border border-gray-200 rounded-md">
                <!-- Scales will be inserted here dynamically -->
            </div>
            <button id="closeModalButton" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 ease-in-out">
                Awesome!
            </button>
        </div>
    </div>

    <!-- Harmonic/Melodic Selection Modal -->
    <div id="minorSelectionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-3xl font-bold text-purple-600 mb-4">Choose Minor Scales</h3>
            <p class="text-xl text-gray-700 mb-6">Would you like to practise Harmonic or Melodic minor scales for this grade?</p>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="harmonicButton" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 ease-in-out text-lg">
                    Harmonic
                </button>
                <button id="melodicButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 ease-in-out text-lg">
                    Melodic
                </button>
            </div>
            <button id="closeMinorSelectionModalButton" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 ease-in-out mt-6">
                Close (Default to Harmonic)
            </button>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-3xl font-bold text-gray-800 mb-4">Help & Features</h3>
            <div id="helpModalContent" class="text-gray-700 text-left text-base leading-relaxed space-y-4">
                <p>Welcome to Elliot's Scale Practise App! This tool is designed to help viola students prepare for their MTB exams by providing randomised scale practise and helpful features.</p>
                
                <h4 class="text-xl font-semibold text-gray-800 border-b-2 border-gray-300 pb-2 mb-2">Key Features:</h4>
                <ul class="list-disc list-inside space-y-2">
                    <li><strong>Grade Selection:</strong> Choose your exam grade (1-8) to load the corresponding scales and arpeggios.</li>
                    <li><strong>Randomised Practise:</strong> In "Random Mode" (default), click "Gimme a Scale!" to get a random scale or arpeggio from your selected grade. The app keeps track of scales played in a round, showing them as greyed out.</li>
                    <li><strong>Practise Mode:</strong> Use the "Toggle Practise Mode" button to switch to a mode where you can select any scale directly from the "All Scales & Arpeggios" list below. This is great for focused practise.</li>
                    <li><strong>Melodic/Harmonic Minor Selection:</strong> For Grades 2-5, a popup will ask you to choose between Harmonic and Melodic minor scales, ensuring you practise the correct form.</li>
                    <li><strong>Adjust Playback Speed (BPM):</strong> Use the slider to control the beats per minute (BPM) for audio demonstrations, allowing you to practise at your desired tempo.</li>
                    <li><strong>Adjust Volume:</strong> Control the volume of the audio demonstration using the volume slider.</li>
                    <li><strong>Audio Demonstration:</strong> Click the "Play Demo" button to hear a synthesised playback of the currently displayed scale or arpeggio.</li>
                    <li><strong>"Long Tonics" Playback:</strong> In MTB Exams, for all of the major and minor scales (natural, harmonic, melodic) in the syllabus, you need to play your scales as a "Long Tonic" scale. This is where the tonic note of each octave lasts twice the duration of other notes. The demonstration should automatically use this rhythm!</li>
                    <li><strong>Correct Melodic Minor Descent:</strong> Melodic minor scales are played correctly: ascending with raised 6th and 7th, and descending in the natural minor form.</li>
                    <li><strong>Rate Your Performance:</strong> After playing a scale, use the 5-star rating system to assess how well you performed (1 = Hardest, 5 = Easiest). This helps the app track your progress.</li>
                    <li><strong>Round Completion Summary:</strong> Once you've played all scales in "Random Mode", a "Congratulations!" popup will show you your scales ordered from hardest to easiest based on your ratings, helping you identify areas for improvement.</li>
                    <li><strong>Return to Grade Selection:</strong> The "Back to Grades" button allows you to easily switch to a different exam grade.</li>
                </ul>
                <p>Enjoy your practise!</p>
            </div>
            <button id="closeHelpModalButton" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 ease-in-out mt-6">
                Got It!
            </button>
        </div>
    </div>


    <script>
        // UI Element References
        const mainTitle = document.getElementById('mainTitle');
        const gradeSelectionScreen = document.getElementById('gradeSelectionScreen');
        const gradeButtonsContainer = document.getElementById('gradeButtonsContainer');
        const practiceScreen = document.getElementById('practiceScreen');
        const scaleDisplay = document.getElementById('scaleDisplay');
        const gimmeScaleButton = document.getElementById('gimmeScaleButton');
        const togglePracticeModeButton = document.getElementById('togglePracticeModeButton');
        const bpmSlider = document.getElementById('bpmSlider');
        const bpmValueDisplay = document.getElementById('bpmValueDisplay');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValueDisplay = document.getElementById('volumeValueDisplay');
        const allScalesListContainer = document.getElementById('allScalesList');
        const actionContainer = document.getElementById('actionContainer');
        const demonstrationButton = document.getElementById('demonstrationButton');
        const starRatingContainer = document.getElementById('starRatingContainer');
        const stars = document.querySelectorAll('.star-rating .star');
        const congratulationsModal = document.getElementById('congratulationsModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalScalesList = document.getElementById('modalScalesList');
        const backToGradesButton = document.getElementById('backToGradesButton');
        const minorSelectionModal = document.getElementById('minorSelectionModal');
        const harmonicButton = document.getElementById('harmonicButton');
        const melodicButton = document.getElementById('melodicButton');
        const closeMinorSelectionModalButton = document.getElementById('closeMinorSelectionModalButton');
        const helpIcon = document.getElementById('helpIcon');
        const helpModal = document.getElementById('helpModal');
        const closeHelpModalButton = document.getElementById('closeHelpModalButton');

        // Tone.js Setup
        const synth = new Tone.PolySynth(Tone.Synth, {
            maxPolyphony: 8, // Explicitly setting max voices
            envelope: {
                attack: 0.05, // Slightly increased attack
                decay: 0.3,
                sustain: 0.1,
                release: 0.5, // Slightly increased release
            },
            oscillator: {
                type: "triangle" // Reverted oscillator type to triangle
            }
        }).toDestination();

        Tone.Transport.bpm.value = bpmSlider.value;
        Tone.Destination.volume.value = 0; // Set initial volume for Tone.js to 0dB (corresponds to 100% on slider)

        // Global variables
        let selectedMinorType = 'harmonic'; // Default to harmonic
        let currentAllScales = []; // This will hold the FULL list of scales for the currently selected grade (objects)
        let scaleRatings = {}; // Ratings for the current grade
        let availableScales = []; // This will hold the currently FILTERED and available scales for random selection (objects)
        let previousScale = null; // Stores the previously played scale object for anti-repetition
        let currentScaleSelected = null; // Stores the NAME of the currently selected scale string
        let isFirstRandomRoundCompleted = false;
        let audioContextStarted = false;
        let isPlayingDemo = false;
        let isPracticeMode = false;
        let currentGrade = null; // Stores the currently selected grade string

        // Diagnostic check: Verify Tone.Midi() conversion
        console.log(`DIAGNOSTIC: Tone.Midi(64).toNote() returns: ${Tone.Midi(64).toNote()}`);
        console.log(`DIAGNOSTIC: Tone.Midi(0).toNote() returns: ${Tone.Midi(0).toNote()}`); // Added check for C0


        // --- Note Mapping for Sharps and Flats ---
        const noteMap = {
            "C": 0, "C#": 1, "DB": 1,
            "D": 2, "D#": 3, "EB": 3,
            "E": 4, "F": 5, "F#": 6, "GB": 6,
            "G": 7, "G#": 8, "AB": 8,
            "A": 9, "A#": 10, "BB": 10,
            "B": 11
        };

        const noteNamesByIndex = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

        // Define intervals for different scale types
        const scaleIntervals = {
            'major': [0, 2, 4, 5, 7, 9, 11],
            'natural minor': [0, 2, 3, 5, 7, 8, 10],
            'harmonic minor': [0, 2, 3, 5, 7, 8, 11],
            'melodic minor_ascending': [0, 2, 3, 5, 7, 9, 11],
            'melodic minor_descending': [0, 2, 3, 5, 7, 8, 10], // This is equivalent to natural minor for melodic minor descent
            'chromatic': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
        };

        // --- Grade-specific Scale Data ---
        // Each scale is an object with 'name' and 'startNote' properties.
        // Minor scales (harmonic/melodic) also have a 'minorType' property.
        const allGradeScales = {
            'Grade 1': [
                { name: "C major scale - 2 octaves", startNote: "C3" },
                { name: "G major scale - 1 octave", startNote: "G3" },
                { name: "D natural minor scale - 1 octave", startNote: "D3" },
                { name: "C major arpeggio - 2 octaves", startNote: "C3" },
                { name: "G major arpeggio - 1 octave", startNote: "G3" },
                { name: "D minor arpeggio - 1 octave", startNote: "D3" }
            ],
            'Grade 2': [
                { name: "Bb major scale - 1 octave", startNote: "Bb3" },
                { name: "Eb major scale - 2 octaves", startNote: "Eb3" },
                { name: "F major scale - 1 octave", startNote: "F3" },
                { name: "C harmonic minor scale - 2 octaves", startNote: "C3", minorType: 'harmonic' },
                { name: "C melodic minor scale - 2 octaves", startNote: "C3", minorType: 'melodic' },
                { name: "Bb major arpeggio - 1 octave", startNote: "Bb3" },
                { name: "Eb major arpeggio - 2 octaves", startNote: "Eb3" },
                { name: "F major arpeggio - 1 octave", startNote: "F3" },
                { name: "C minor arpeggio - 2 octaves", startNote: "C3" }
            ],
            'Grade 3': [
                { name: "Ab major scale - 1 octave", startNote: "Ab3" },
                { name: "A major scale - 1 octave", startNote: "A3" },
                { name: "G harmonic minor scale - 2 octaves", startNote: "G3", minorType: 'harmonic' },
                { name: "G melodic minor scale - 2 octaves", startNote: "G3", minorType: 'melodic' },
                { name: "G major scale - 2 octaves", startNote: "G3" },
                { name: "Ab major arpeggio - 1 octave", startNote: "Ab3" },
                { name: "A major arpeggio - 1 octave", startNote: "A3" },
                { name: "G minor arpeggio - 2 octaves", startNote: "G3" },
                { name: "Chromatic Scale on G - 1 octave", startNote: "G3" },
                { name: "Dominant 7th in the key of F - 1 octave", startNote: "C4" }
            ],
            'Grade 4': [
                { name: "E major scale - 2 octaves", startNote: "E3" },
                { name: "A major scale - 2 octaves", startNote: "A3" },
                { name: "F harmonic minor scale - 2 octaves", startNote: "F3", minorType: 'harmonic' },
                { name: "F melodic minor scale - 2 octaves", startNote: "F3", minorType: 'melodic' },
                { name: "E major arpeggio - 2 octaves", startNote: "E3" },
                { name: "A major arpeggio - 2 octaves", startNote: "A3" },
                { name: "F minor arpeggio - 2 octaves", startNote: "F3" },
                { name: "Bb minor arpeggio - 2 octaves", startNote: "Bb3" },
                { name: "Chromatic Scale on C - 1 octave", startNote: "C4" },
                { name: "Dominant 7th in C - 1 octave", startNote: "G3" }
            ],
            'Grade 5': [
                { name: "F# Major Scale - 2 octaves", startNote: "F#3" },
                { name: "C Major Scale - 3 octaves", startNote: "C3" },
                { name: "D Harmonic Minor Scale - 3 octaves", startNote: "D3", minorType: 'harmonic' },
                { name: "D Melodic Minor Scale - 3 octaves", startNote: "D3", minorType: 'melodic' },
                { name: "F# Major Arpeggio - 2 octaves", startNote: "F#3" },
                { name: "C Major Arpeggio - 3 octaves", startNote: "C3" },
                { name: "D Minor Arpeggio - 3 octaves", startNote: "D3" },
                { name: "F# Minor Arpeggio - 2 octaves", startNote: "F#3" },
                { name: "Chromatic Scale on D - 2 octaves", startNote: "D4" },
                { name: "Dominant 7th in F - 2 octaves", startNote: "C4" },
                { name: "Diminished 7th on G - 1 octave", startNote: "G3" }
            ],
            'Grade 6': [
                { name: "Eb major scale - 3 octaves", startNote: "Eb3" },
                { name: "C harmonic minor scale - 3 octaves", startNote: "C3", minorType: 'harmonic' },
                { name: "Eb melodic minor scale - 3 octaves", startNote: "Eb3", minorType: 'melodic' },
                { name: "Eb major arpeggio - 3 octaves", startNote: "Eb3" },
                { name: "C minor arpeggio - 3 octaves", startNote: "C3" },
                { name: "Eb minor arpeggio - 3 octaves", startNote: "Eb3" },
                { name: "Chromatic Scale on Eb - 2 octaves", startNote: "Eb3" },
                { name: "Dominant 7th in G - 2 octaves", startNote: "D3" },
                { name: "Diminished 7th on C - 2 octaves", startNote: "C3" },
                { name: "Double Stopping Tetrachord - C Major in 6ths, in broken steps", startNote: "C3", playbackRule: 'brokenStepsTetrachord6ths' }
            ],
            'Grade 7': [
                { name: "E major scale - 3 octaves", startNote: "E3" },
                { name: "G harmonic minor scale - 3 octaves", startNote: "G3", minorType: 'harmonic' },
                { name: "E melodic minor scale - 3 octaves", startNote: "E3", minorType: 'melodic' },
                { name: "E major arpeggio - 3 octaves", startNote: "E3" },
                { name: "G minor arpeggio - 3 octaves", startNote: "G3" },
                { name: "E minor arpeggio - 3 octaves", startNote: "E3" },
                { name: "Chromatic Scale on D - 3 octaves", startNote: "D3" },
                { name: "Dominant 7th in Eb - 2 octaves", startNote: "Bb4" },
                { name: "Diminished 7th on D - 2 octaves", startNote: "D3" },
                { name: "Double Stopping C major scale in 6ths - 2 octaves", startNote: "E3", playbackRule: 'brokenStepsFullScale6ths' }, // Changed startNote to E3
                { name: "E Major Tetrachord in octaves", startNote: "E4", playbackRule: 'brokenStepsTetrachordOctaves' } // Changed startNote to E4
            ],
            'Grade 8': [
                { name: "Ab Major Scale - 3 Octaves", startNote: "Ab3" },
                { name: "C# Melodic Minor Scale - 3 octaves", startNote: "C#3", minorType: 'melodic' },
                { name: "Ab Harmonic Minor Scale - 3 Octaves", startNote: "Ab3", minorType: 'harmonic' },
                { name: "Ab Major Arpeggio - 3 Octaves", startNote: "Ab3" },
                { name: "Ab Minor Arpeggio - 3 Octaves", startNote: "Ab3" },
                { name: "Chromatic Scale on Db - 3 octaves", startNote: "Db3" },
                { name: "Dominant 7th in Bb - 3 octaves", startNote: "F3" }, // Bb dominant 7th starts on F
                { name: "Diminished 7th on A - 3 octaves", startNote: "A3" }, // Corrected start note to A3
                { name: "Double stopping C Major in 6ths", startNote: "E3", playbackRule: 'simultaneousSixthsCMajor' },
                { name: "Double stopping E Major in octaves (broken steps), 1 octave", startNote: "E4", playbackRule: 'brokenStepsOctavesEMajor' },
                { name: "Double stopping Eb major scale in 3rds (broken steps), 1 octave", startNote: "Eb3", playbackRule: 'brokenStepsThirdsEbMajor' }
            ]
        };

        // New object to define default playback tempi and display strings per grade and type
        const gradeDefaultTempi = {
            'Grade 1': {
                'major': { bpm: 50, displayTempo: 'Crotchet = 50bpm' },
                'natural minor': { bpm: 50, displayTempo: 'Crotchet = 50bpm' },
                'harmonic minor': { bpm: 50, displayTempo: 'Crotchet = 50bpm' },
                'melodic minor': { bpm: 50, displayTempo: 'Crotchet = 50bpm' },
                'arpeggio': { bpm: 72, displayTempo: 'Quaver = 72bpm' }
            },
            'Grade 2': {
                'major': { bpm: 56, displayTempo: 'Crotchet = 56bpm' },
                'natural minor': { bpm: 56, displayTempo: 'Crotchet = 56bpm' },
                'harmonic minor': { bpm: 56, displayTempo: 'Crotchet = 56bpm' },
                'melodic minor': { bpm: 56, displayTempo: 'Crotchet = 56bpm' },
                'arpeggio': { bpm: 80, displayTempo: 'Quaver = 80bpm' }
            },
            'Grade 3': {
                'major': { bpm: 66, displayTempo: 'Crotchet = 66bpm' },
                'natural minor': { bpm: 66, displayTempo: 'Crotchet = 66bpm' },
                'harmonic minor': { bpm: 66, displayTempo: 'Crotchet = 66bpm' },
                'melodic minor': { bpm: 66, displayTempo: 'Crotchet = 66bpm' },
                'arpeggio': { bpm: 92, displayTempo: 'Quaver = 92bpm' },
                'chromatic': { bpm: 44, displayTempo: 'Crotchet = 44bpm (triplets)' },
                'dominant 7th': { bpm: 62, displayTempo: 'Crotchet = 62bpm (Quaver = 124bpm)' }
            },
            'Grade 4': {
                'major': { bpm: 72, displayTempo: 'Crotchet = 72bpm' },
                'natural minor': { bpm: 72, displayTempo: 'Crotchet = 72bpm' },
                'harmonic minor': { bpm: 72, displayTempo: 'Crotchet = 72bpm' },
                'melodic minor': { bpm: 72, displayTempo: 'Crotchet = 72bpm' },
                'arpeggio': { bpm: 100, displayTempo: 'Quaver = 100bpm' },
                'chromatic': { bpm: 46, displayTempo: 'Crotchet = 46bpm (triplets)' },
                'dominant 7th': { bpm: 62, displayTempo: 'Crotchet = 62bpm (Quaver = 124bpm)' }
            },
            'Grade 5': {
                'major': { bpm: 72, displayTempo: 'Crotchet = 72bpm' },
                'natural minor': { bpm: 72, displayTempo: 'Crotchet = 72bpm' },
                'harmonic minor': { bpm: 72, displayTempo: 'Crotchet = 72bpm' },
                'melodic minor': { bpm: 72, displayTempo: 'Crotchet = 72bpm' },
                'arpeggio': { bpm: 100, displayTempo: 'Quaver = 100bpm' },
                'dominant 7th': { bpm: 64, displayTempo: 'Crotchet = 64bpm (Quaver = 128bpm)' },
                'diminished 7th': { bpm: 64, displayTempo: 'Crotchet = 64bpm (Quaver = 128bpm)' },
                'chromatic': { bpm: 54, displayTempo: 'Crotchet = 54bpm (triplets)' }
            },
            'Grade 6': {
                'major': { bpm: 72, displayTempo: 'Crotchet = 72bpm' },
                'natural minor': { bpm: 72, displayTempo: 'Crotchet = 72bpm' },
                'harmonic minor': { bpm: 72, displayTempo: 'Crotchet = 72bpm' },
                'melodic minor': { bpm: 72, displayTempo: 'Crotchet = 72bpm' },
                'arpeggio': { bpm: 100, displayTempo: 'Quaver = 100bpm' },
                'dominant 7th': { bpm: 68, displayTempo: 'Crotchet = 68bpm (Quaver = 136bpm)' },
                'diminished 7th': { bpm: 68, displayTempo: 'Quaver = 136bpm' },
                'chromatic': { bpm: 84, displayTempo: 'Crotchet = 84bpm' },
                'brokenStepsTetrachord6ths': { bpm: 84, displayTempo: 'Crotchet = 84bpm (Crotchet, Crotchet, Minim)' }
            },
            'Grade 7': {
                'major': { bpm: 80, displayTempo: 'Crotchet = 80bpm' },
                'natural minor': { bpm: 80, displayTempo: 'Crotchet = 80bpm' },
                'harmonic minor': { bpm: 80, displayTempo: 'Crotchet = 80bpm' },
                'melodic minor': { bpm: 80, displayTempo: 'Crotchet = 80bpm' },
                'arpeggio': { bpm: 111, displayTempo: 'Quaver = 111bpm (Dotted Crotchet = 37bpm)' },
                'chromatic': { bpm: 92, displayTempo: 'Quaver = 92bpm' },
                'dominant 7th': { bpm: 68, displayTempo: 'Quaver = 68bpm' },
                'diminished 7th': { bpm: 68, displayTempo: 'Quaver = 68bpm' },
                'brokenStepsFullScale6ths': { bpm: 84, displayTempo: 'Crotchet = 84bpm (Crotchet, Crotchet, Minim)' },
                'brokenStepsTetrachordOctaves': { bpm: 84, displayTempo: 'Crotchet = 84bpm (Crotchet, Crotchet, Minim)' }
            },
            'Grade 8': {
                'major': { bpm: 92, displayTempo: 'Crotchet = 92bpm' },
                'natural minor': { bpm: 92, displayTempo: 'Crotchet = 92bpm' }, // Assuming natural minor uses same bpm as major/harmonic/melodic
                'harmonic minor': { bpm: 92, displayTempo: 'Crotchet = 92bpm' },
                'melodic minor': { bpm: 92, displayTempo: 'Crotchet = 92bpm' },
                'arpeggio': { bpm: 108, displayTempo: 'Quaver = 108bpm (Dotted Crotchet = 37bpm)' }, // Corrected BPM and display
                'chromatic': { bpm: 114, displayTempo: 'Quaver = 114bpm' },
                'dominant 7th': { bpm: 68, displayTempo: 'Quaver = 68bpm' },
                'diminished 7th': { bpm: 68, displayTempo: 'Quaver = 68bpm' },
                'simultaneousSixthsCMajor': { bpm: 72, displayTempo: 'Crotchet = 72bpm (Minim, Crotchet)' }, // Specific rule for C Major 6ths
                'brokenStepsOctavesEMajor': { bpm: 92, displayTempo: 'Crotchet = 92bpm (Broken Steps)' }, // Specific rule for E Major Octaves
                'brokenStepsThirdsEbMajor': { bpm: 92, displayTempo: 'Crotchet = 92bpm (Broken Steps)' } // Specific rule for Eb Major 3rds
            }
        };

        // --- Function Definitions ---

        /**
         * Converts a note string (e.g., "C#", "Eb") to its MIDI pitch class index (0-11).
         * @param {string} noteString - The note name (e.g., "C", "F#", "Bb").
         * @returns {number} The pitch class index (0-11) or -1 if invalid.
         */
        function getNoteIndex(noteString) {
            if (!noteString) return -1;
            const upperCaseNote = noteString.toUpperCase();
            if (upperCaseNote.startsWith("DB")) return noteMap["C#"]; // Db is enharmonic to C#
            if (upperCaseNote.startsWith("EB")) return noteMap["D#"]; // Eb is enharmonic to D#
            if (upperCaseNote.startsWith("GB")) return noteMap["F#"]; // Gb is enharmonic to F#
            if (upperCaseNote.startsWith("AB")) return noteMap["G#"]; // Ab is enharmonic to G#
            if (upperCaseNote.startsWith("BB")) return noteMap["A#"]; // Bb is enharmonic to A#
            return noteMap[upperCaseNote] !== undefined ? noteMap[upperCaseNote] : -1;
        }

        /**
         * Parses the scale name string to extract root, type, and octaves.
         * @param {string} scaleFullName - The full scale name string (e.g., "C major scale - 1 octave").
         * @returns {object|null} An object with root, type, octaves, and original string, or null if parsing fails.
         */
        function parseScaleName(scaleFullName) {
            const lowerCaseName = scaleFullName.toLowerCase();
            const parts = lowerCaseName.split(' ');

            let root = '';
            let type = '';
            let octaves = 1;

            if (lowerCaseName.includes("dominant 7th in")) {
                const inIndex = parts.indexOf('in');
                if (inIndex !== -1 && parts.length > inIndex + 1) {
                    root = parts[inIndex + 1].toUpperCase();
                } else {
                    console.error(`Could not parse key tonic for dominant 7th: ${scaleFullName}`);
                    return null;
                }
                type = 'dominant 7th';
            } else if (lowerCaseName.includes("diminished 7th on")) {
                const onIndex = parts.indexOf('on');
                if (onIndex !== -1 && parts.length > onIndex + 1) {
                    root = parts[onIndex + 1].toUpperCase();
                } else {
                    console.error(`Could not parse root for diminished 7th: ${scaleFullName}`);
                    return null;
                }
                type = 'diminished 7th';
            } else if (lowerCaseName.includes("double stopping tetrachord")) {
                 // For "Double Stopping Tetrachord - C Major in 6ths, in broken steps"
                const majorInIndex = parts.indexOf('major');
                if (majorInIndex !== -1) {
                    root = parts[majorInIndex - 1].toUpperCase(); // Get 'C' from "C Major"
                } else {
                    root = parts[0].toUpperCase(); // Fallback if format is different
                }
                type = 'tetrachord in 6ths'; // Specific type for this scale
                const octavesMatch = lowerCaseName.match(/(\d)\s*octaves?/);
                if (octavesMatch) octaves = parseInt(octavesMatch[1]);
                else octaves = 2; // Default for this type if not explicitly mentioned
            } else if (lowerCaseName.includes("scale in 6ths") && !lowerCaseName.includes("double stopping")) { // Exclude specific double stopping
                root = parts[0].toUpperCase();
                type = 'scale in 6ths';
            } else if (lowerCaseName.includes("tetrachord in octaves") && !lowerCaseName.includes("double stopping")) { // Exclude specific double stopping
                root = parts[0].toUpperCase();
                type = 'tetrachord in octaves';
                octaves = 1;
            } else if (lowerCaseName.includes("chromatic scale on")) {
                const onIndex = parts.indexOf('on');
                if (onIndex !== -1 && parts.length > onIndex + 1) {
                    root = parts[onIndex + 1].toUpperCase();
                } else {
                    console.error(`Could not parse root for chromatic scale: ${scaleFullName}`);
                    return null;
                }
                type = 'chromatic';
            } else if (lowerCaseName.includes("double stopping c major in 6ths") && !lowerCaseName.includes("broken steps")) {
                root = 'C';
                type = 'double stopping';
                octaves = 2; // Fixed 2 octaves for this scale
            } else if (lowerCaseName.includes("double stopping e major in octaves (broken steps)")) {
                root = 'E';
                type = 'double stopping';
                octaves = 1; // Fixed 1 octave for this scale
            } else if (lowerCaseName.includes("double stopping eb major scale in 3rds (broken steps)")) {
                root = 'Eb';
                type = 'double stopping';
                octaves = 1; // Fixed 1 octave for this scale
            }
            else {
                root = parts[0].toUpperCase();
                if (lowerCaseName.includes("major scale")) type = 'major';
                else if (lowerCaseName.includes("harmonic minor scale")) type = 'harmonic minor';
                else if (lowerCaseName.includes("melodic minor scale")) type = 'melodic minor';
                else if (lowerCaseName.includes("natural minor scale")) type = 'natural minor';
                else if (lowerCaseName.includes("chromatic scale")) type = 'chromatic';
                else if (lowerCaseName.includes("arpeggio")) type = 'arpeggio';
                else {
                    console.error(`Could not determine type for scale: ${scaleFullName}`);
                    return null;
                }
            }

            const octaveMatch = lowerCaseName.match(/(\d)\s*octaves?/);
            if (octaveMatch && octaveMatch[1]) {
                octaves = parseInt(octaveMatch[1]);
            }

            return { root, type, octaves, originalString: lowerCaseName };
        }

        /**
         * Calculates the MIDI note of a diatonic 6th above a given lower MIDI note in a C Major context.
         * @param {number} lowerMidiNote - The MIDI value of the lower note.
         * @returns {number} The MIDI value of the upper note forming a diatonic 6th.
         */
        function getDiatonic6thAboveCMajor(lowerMidiNote) {
            const cMajorScaleIntervals = [0, 2, 4, 5, 7, 9, 11]; // Intervals from C to C, D, E, F, G, A, B
            const lowerNotePitchClass = lowerMidiNote % 12; // Pitch class (0-11)
            const baseOctave = Math.floor(lowerMidiNote / 12);

            let lowerNoteScaleIndex = -1;
            for (let i = 0; i < cMajorScaleIntervals.length; i++) {
                if (cMajorScaleIntervals[i] === lowerNotePitchClass) {
                    lowerNoteScaleIndex = i;
                    break;
                }
            }

            if (lowerNoteScaleIndex === -1) {
                console.warn(`Note ${Tone.Midi(lowerMidiNote).toNote()} is not diatonic to C Major. Falling back to Major 6th.`);
                return lowerMidiNote + 9; // Fallback to a generic Major 6th (9 semitones)
            }

            const sixthNoteScaleIndex = (lowerNoteScaleIndex + 5) % cMajorScaleIntervals.length;
            const octaveShift = Math.floor((lowerNoteScaleIndex + 5) / cMajorScaleIntervals.length);

            const upperMidiNote = (baseOctave + octaveShift) * 12 + cMajorScaleIntervals[sixthNoteScaleIndex];
            return upperMidiNote;
        }

        /**
         * Calculates the MIDI note of a diatonic interval above a given lower MIDI note in a specified major scale.
         * Assumes input lowerMidiNote is valid and is a member of the specified scale.
         * @param {number} lowerMidiNote - The MIDI value of the lower note.
         * @param {string} scaleRoot - The root of the major scale (e.g., "C", "E", "Eb").
         * @param {number} intervalDegrees - The number of scale degrees above the lower note (e.g., 2 for a 3rd, 5 for a 6th).
         * @returns {number} The MIDI value of the upper note forming the diatonic interval.
         */
        function getDiatonicIntervalAboveMajor(lowerMidiNote, scaleRoot, intervalDegrees) {
            const majorScaleIntervals = [0, 2, 4, 5, 7, 9, 11]; // Intervals from root to root in a major scale
            const rootPitchClass = getNoteIndex(scaleRoot);

            const oneOctaveScalePcs = [];
            for (const interval of majorScaleIntervals) {
                oneOctaveScalePcs.push((rootPitchClass + interval) % 12);
            }
            oneOctaveScalePcs.sort((a,b)=>a-b); // Ensure sorted for consistent indexing

            const lowerNotePitchClass = lowerMidiNote % 12;
            const baseOctave = Math.floor(lowerMidiNote / 12);

            let lowerNoteScaleIndex = oneOctaveScalePcs.indexOf(lowerNotePitchClass);

            if (lowerNoteScaleIndex === -1) {
                console.warn(`Note ${Tone.Midi(lowerMidiNote).toNote()} (pitch class ${lowerNotePitchClass}) is not diatonic to ${scaleRoot} Major scale. Cannot calculate diatonic interval. Falling back to chromatic interval.`);
                // Fallback to chromatic interval (e.g., Major 3rd is 4 semitones, Major 6th is 9 semitones)
                return lowerMidiNote + (intervalDegrees === 2 ? 4 : (intervalDegrees === 5 ? 9 : 0)); // Default to 0 if unknown
            }

            const targetScaleIndex = lowerNoteScaleIndex + intervalDegrees;

            // Determine octave shift if the target note goes into the next octave of the scale
            const finalOctaveShift = Math.floor(targetScaleIndex / oneOctaveScalePcs.length);
            const finalPitchClassIndexInScale = targetScaleIndex % oneOctaveScalePcs.length;
            const finalPitchClass = oneOctaveScalePcs[finalPitchClassIndexInScale];

            const upperMidiNote = (baseOctave + finalOctaveShift) * 12 + finalPitchClass;
            return upperMidiNote;
        }


        /**
         * Generates an array of Tone.js note sequences, including notes and their durations.
         * For scales (major, minors), applies "long tonics". Other types have standard durations.
         * @param {object} scaleObj - An object containing 'name', 'startNote', and optionally 'playbackRule'.
         * @returns {Array<{notes: string|string[], duration: string}>} An array of note events.
         */
        function getScaleNotes(scaleObj) {
            const scaleFullName = scaleObj.name;
            const startingViolaNote = scaleObj.startNote;

            const parsed = parseScaleName(scaleFullName);
            if (!parsed) return [];

            const { root, type, octaves, originalString } = parsed;
            let sequenceData = [];

            const initialBaseMidi = Tone.Midi(startingViolaNote).toMidi();
            const rootNoteOnly = root; // Use the parsed root for tonic determination
            const initialRootPitchClass = getNoteIndex(rootNoteOnly);

            // Helper to determine if a note is a tonic relative to the initial root pitch class
            const isScaleTonic = (midiNote) => {
                // If it's already a MIDI number, use it directly. If it's a string, convert.
                const midiVal = typeof midiNote === 'string' ? Tone.Midi(midiNote).toMidi() : midiNote;
                return (midiVal % 12) === initialRootPitchClass;
            };

            let baseNoteDuration = '8n'; // Default to quavers for most scales and arpeggios
            let longTonicDuration = '4n'; // Default long tonic duration (crotchet)

            // Special cases for baseNoteDuration before main logic
            if (type === 'arpeggio') {
                baseNoteDuration = '8n'; // Arpeggio notes are quavers, as per Grade 8 syllabus details
            } else if (type === 'chromatic') {
                baseNoteDuration = '8n'; // Chromatic scale notes are quavers
            }

            // Common broken step rhythm sequence generation
            // This function will take an array of MIDI notes (single notes or [lower, upper] pairs)
            // and apply the broken step rhythm, converting to note strings for Tone.js.
            const applyBrokenStepRhythm = (notesAndPairsMidiArray) => {
                let currentSequenceChunk = [];
                notesAndPairsMidiArray.forEach(item => {
                    if (Array.isArray(item)) { // It's a pair of MIDI notes (e.g., for 3rds or 6ths)
                        const lowerNoteStr = Tone.Midi(item[0]).toNote();
                        const upperNoteStr = Tone.Midi(item[1]).toNote();
                        currentSequenceChunk.push({ notes: [lowerNoteStr], duration: '4n' }); // Bottom note only (crotchet)
                        currentSequenceChunk.push({ notes: [lowerNoteStr, upperNoteStr], duration: '4n' });     // Both notes (crotchet)
                        currentSequenceChunk.push({ notes: [lowerNoteStr, upperNoteStr], duration: '2n' });     // Both notes (minim)
                    } else { // It's a single MIDI note (for octaves)
                        const singleNoteStr = Tone.Midi(item).toNote();
                        const octaveNoteStr = Tone.Midi(item + 12).toNote(); // Octave note as string
                        currentSequenceChunk.push({ notes: [singleNoteStr], duration: '4n' }); // Single note (crotchet)
                        currentSequenceChunk.push({ notes: [singleNoteStr, octaveNoteStr], duration: '4n' }); // Octave pair (crotchet)
                        currentSequenceChunk.push({ notes: [singleNoteStr, octaveNoteStr], duration: '2n' }); // Octave pair (minim)
                    }
                });
                return currentSequenceChunk;
            };

            // Helper to get actual pitch classes for a major scale given a root pitch class
            function getMajorScalePitchClasses(rootPc) {
                const majorIntervals = [0, 2, 4, 5, 7, 9, 11];
                return majorIntervals.map(interval => (rootPc + interval) % 12);
            }


            if (scaleObj.playbackRule === 'simultaneousSixthsCMajor') {
                const lowerVoiceStartMidi = Tone.Midi(startingViolaNote).toMidi(); // E3 for Grade 8 C Major 6ths
                const numOctaves = 2; // For C Major 6ths, it's 2 octaves

                const lowerVoiceScaleMidi = [];
                let tempMidi = lowerVoiceStartMidi;
                const cRootPc = getNoteIndex('C');
                const cMajorPcs = getMajorScalePitchClasses(cRootPc);

                const getNextCMajorDiatonicNote = (currentMidi) => {
                    let nextMidi = currentMidi + 1;
                    while (true) {
                        const nextPc = nextMidi % 12;
                        if (cMajorPcs.includes(nextPc)) {
                            return nextMidi;
                        }
                        nextMidi++;
                        if (nextMidi > currentMidi + 12) {
                            console.error("Couldn't find next C Major diatonic note.");
                            return -1;
                        }
                    }
                };

                tempMidi = lowerVoiceStartMidi;
                while (tempMidi <= Tone.Midi('E5').toMidi()) {
                    lowerVoiceScaleMidi.push(tempMidi);
                    if (tempMidi === Tone.Midi('E5').toMidi()) break;
                    tempMidi = getNextCMajorDiatonicNote(tempMidi);
                    if (tempMidi === -1) break;
                }

                let simultaneousPairs = [];
                lowerVoiceScaleMidi.forEach((lowerMidi) => {
                    const upperMidi = getDiatonicIntervalAboveMajor(lowerMidi, 'C', 5); // Diatonic 6th in C Major
                    simultaneousPairs.push([lowerMidi, upperMidi]);
                });

                simultaneousPairs.forEach((pair, index) => {
                    const duration = (index === 0 || index === simultaneousPairs.length - 1) ? '2n' : '4n';
                    sequenceData.push({ notes: [Tone.Midi(pair[0]).toNote(), Tone.Midi(pair[1]).toNote()], duration: duration });
                });

                const descendingPairs = [...simultaneousPairs].reverse();
                if (descendingPairs.length > 0) {
                    descendingPairs.shift();
                }

                descendingPairs.forEach((pair, index) => {
                    const duration = (index === descendingPairs.length - 1) ? '2n' : '4n';
                    sequenceData.push({ notes: [Tone.Midi(pair[0]).toNote(), Tone.Midi(pair[1]).toNote()], duration: duration });
                });

                return sequenceData;

            } else if (scaleObj.playbackRule === 'brokenStepsOctavesEMajor') {
                const startMidi = Tone.Midi(startingViolaNote).toMidi(); // E4
                const numOctaves = 1;
                const topMidiInScale = startMidi + (numOctaves * 12); // E5

                const eMajorScaleNotesMidi = [];
                let tempMidi = startMidi;
                const eRootPc = getNoteIndex('E');
                const eMajorPcs = getMajorScalePitchClasses(eRootPc);

                const getNextEMajorDiatonicNote = (currentMidi) => {
                    let nextMidi = currentMidi + 1;
                    while (true) {
                        const nextPc = nextMidi % 12;
                        if (eMajorPcs.includes(nextPc)) {
                            return nextMidi;
                        }
                        nextMidi++;
                        if (nextMidi > currentMidi + 12) {
                            console.error("Couldn't find next E Major diatonic note.");
                            return -1;
                        }
                    }
                };

                while (tempMidi <= topMidiInScale) {
                    eMajorScaleNotesMidi.push(tempMidi);
                    if (tempMidi === topMidiInScale) break;
                    tempMidi = getNextEMajorDiatonicNote(tempMidi);
                    if (tempMidi === -1) break;
                }

                sequenceData.push(...applyBrokenStepRhythm(eMajorScaleNotesMidi));

                const descendingNotesMidi = [...eMajorScaleNotesMidi].reverse();
                if (descendingNotesMidi.length > 0) {
                    descendingNotesMidi.shift();
                }
                sequenceData.push(...applyBrokenStepRhythm(descendingNotesMidi));

                return sequenceData;

            } else if (scaleObj.playbackRule === 'brokenStepsThirdsEbMajor') {
                const startMidi = Tone.Midi(startingViolaNote).toMidi(); // Eb3
                const numOctaves = 1;
                const topMidiInScale = startMidi + (numOctaves * 12); // Eb4

                const ebMajorScaleNotesMidi = [];
                let tempMidi = startMidi;
                const ebRootPc = getNoteIndex('Eb');
                const ebMajorPcs = getMajorScalePitchClasses(ebRootPc);

                const getNextEbMajorDiatonicNote = (currentMidi) => {
                    let nextMidi = currentMidi + 1;
                    while (true) {
                        const nextPc = nextMidi % 12;
                        if (ebMajorPcs.includes(nextPc)) {
                            return nextMidi;
                        }
                        nextMidi++;
                        if (nextMidi > currentMidi + 12) {
                            console.error("Couldn't find next Eb Major diatonic note.");
                            return -1;
                        }
                    }
                };

                while (tempMidi <= topMidiInScale) {
                    ebMajorScaleNotesMidi.push(tempMidi);
                    if (tempMidi === topMidiInScale) break;
                    tempMidi = getNextEbMajorDiatonicNote(tempMidi);
                    if (tempMidi === -1) break;
                }

                let ascendingPairs = [];
                ebMajorScaleNotesMidi.forEach((lowerMidi) => {
                    const upperMidi = getDiatonicIntervalAboveMajor(lowerMidi, 'Eb', 2); // Diatonic 3rd in Eb Major
                    ascendingPairs.push([lowerMidi, upperMidi]);
                });

                sequenceData.push(...applyBrokenStepRhythm(ascendingPairs));

                const descendingPairs = [...ascendingPairs].reverse();
                if (descendingPairs.length > 0) {
                    descendingPairs.shift();
                }
                sequenceData.push(...applyBrokenStepRhythm(descendingPairs));

                return sequenceData;

            } else if (scaleObj.playbackRule === 'brokenStepsTetrachord6ths') { // Grade 6 Double Stopping Tetrachord - C Major in 6ths, in broken steps
                // This rule has a hardcoded E3 as the lowest note for the specific tetrachord from syllabus.
                const lowerTetrachordNotesMidi = [
                    Tone.Midi('E3').toMidi(), Tone.Midi('F3').toMidi(), Tone.Midi('G3').toMidi(), Tone.Midi('A3').toMidi()
                ];
                const upperTetrachordNotesMidi = [
                    Tone.Midi('C4').toMidi(), Tone.Midi('D4').toMidi(), Tone.Midi('E4').toMidi(), Tone.Midi('F4').toMidi()
                ];

                let ascendingPairs = [];
                for (let i = 0; i < lowerTetrachordNotesMidi.length; i++) {
                    ascendingPairs.push([lowerTetrachordNotesMidi[i], upperTetrachordNotesMidi[i]]);
                }

                // Apply broken step rhythm to ascending part
                sequenceData.push(...applyBrokenStepRhythm(ascendingPairs));

                // Descending part
                const descendingPairs = [...ascendingPairs].reverse().slice(1);
                sequenceData.push(...applyBrokenStepRhythm(descendingPairs));

                return sequenceData;

            } else if (scaleObj.playbackRule === 'brokenStepsFullScale6ths') { // Grade 7 Double Stopping C major scale in 6ths - 2 octaves
                const lowerVoiceStartMidi = Tone.Midi(startingViolaNote).toMidi(); // E3
                const numOctaves = 2;
                const topMidiInScale = lowerVoiceStartMidi + (numOctaves * 12); // E5

                const lowerVoiceScaleMidi = [];
                let tempMidi = lowerVoiceStartMidi;
                const cRootPc = getNoteIndex('C');
                const cMajorPcs = getMajorScalePitchClasses(cRootPc);

                const getNextCMajorDiatonicNote = (currentMidi) => {
                    let nextMidi = currentMidi + 1;
                    while (true) {
                        const nextPc = nextMidi % 12;
                        if (cMajorPcs.includes(nextPc)) {
                            return nextMidi;
                        }
                        nextMidi++;
                        if (nextMidi > currentMidi + 12) {
                            console.error("Couldn't find next C Major diatonic note.");
                            return -1;
                        }
                    }
                };

                while (tempMidi <= topMidiInScale) {
                    lowerVoiceScaleMidi.push(tempMidi);
                    if (tempMidi === topMidiInScale) break;
                    tempMidi = getNextCMajorDiatonicNote(tempMidi);
                    if (tempMidi === -1) break;
                }

                let ascendingPairs = [];
                lowerVoiceScaleMidi.forEach(midiNote => {
                    const upperNoteMidi = getDiatonic6thAboveCMajor(midiNote); // Re-using Grade 6/7 specific helper for consistency
                    ascendingPairs.push([midiNote, upperNoteMidi]);
                });

                sequenceData.push(...applyBrokenStepRhythm(ascendingPairs));

                const descendingPairs = [...ascendingPairs].reverse();
                if (descendingPairs.length > 0) {
                    descendingPairs.shift();
                }
                sequenceData.push(...applyBrokenStepRhythm(descendingPairs));

                return sequenceData;

            } else if (scaleObj.playbackRule === 'brokenStepsTetrachordOctaves') { // Grade 7 E Major Tetrachord in octaves
                const tetrachordNotesMidi = [
                    Tone.Midi('E4').toMidi(), Tone.Midi('F#4').toMidi(), Tone.Midi('G#4').toMidi(), Tone.Midi('A4').toMidi()
                ];

                sequenceData.push(...applyBrokenStepRhythm(tetrachordNotesMidi));

                // Descending part: Reverse the notes, exclude the last note (which is the highest ascending)
                const descendingNotesMidi = [...tetrachordNotesMidi].reverse().slice(1);
                sequenceData.push(...applyBrokenStepRhythm(descendingNotesMidi));

                return sequenceData;
            }


            // --- Existing logic for other scale types (single notes or regular arpeggios) ---
            if (['major', 'natural minor', 'harmonic minor'].includes(type)) {
                const intervals = scaleIntervals[type];
                let currentMidi = initialBaseMidi;
                let allNotesMidi = [];

                // Ascending part
                for (let o = 0; o < octaves; o++) {
                    for (let i = 0; i < intervals.length; i++) {
                        // Correctly calculate notes based on initial base and scale intervals
                        const pitchClassOfInterval = (initialBaseMidi % 12 + intervals[i]) % 12;
                        const midiNote = (Math.floor(currentMidi / 12) * 12) + pitchClassOfInterval;
                        allNotesMidi.push(midiNote);
                    }
                    currentMidi += 12; // Move to next octave's base
                }
                // Add the top tonic for the final octave if not already there
                const finalTonicMidi = initialBaseMidi + (octaves * 12);
                if (allNotesMidi[allNotesMidi.length - 1] !== finalTonicMidi) {
                    allNotesMidi.push(finalTonicMidi);
                }


                allNotesMidi.forEach((midiNote, index) => {
                    const noteName = Tone.Midi(midiNote).toNote(); // Convert to note string here
                    const duration = (index === 0 || isScaleTonic(midiNote)) ? longTonicDuration : baseNoteDuration;
                    sequenceData.push({ notes: [noteName], duration: duration }); // Pass note string
                });

                const descendingMidiNotesList = [...allNotesMidi].reverse().slice(1);
                descendingMidiNotesList.forEach((midiNote) => {
                    const noteName = Tone.Midi(midiNote).toNote(); // Convert to note string here
                    const duration = isScaleTonic(midiNote) ? longTonicDuration : baseNoteDuration;
                    sequenceData.push({ notes: [noteName], duration: duration }); // Pass note string
                });

            } else if (type === 'melodic minor') {
                const ascendingIntervals = scaleIntervals['melodic minor_ascending'];
                const descendingIntervals = scaleIntervals['melodic minor_descending'];
                let allAscendingNotesMidi = [];

                let currentAscendingMidi = initialBaseMidi;
                for (let o = 0; o < octaves; o++) {
                    for (let i = 0; i < ascendingIntervals.length; i++) {
                        // Correctly calculate notes based on initial base and scale intervals
                        const pitchClassOfInterval = (initialBaseMidi % 12 + ascendingIntervals[i]) % 12;
                        const midiNote = (Math.floor(currentAscendingMidi / 12) * 12) + pitchClassOfInterval;
                        allAscendingNotesMidi.push(midiNote);
                    }
                    currentAscendingMidi += 12;
                }
                const finalAscendingTonicMidi = initialBaseMidi + (octaves * 12);
                if (allAscendingNotesMidi[allAscendingNotesMidi.length - 1] !== finalAscendingTonicMidi) {
                    allAscendingNotesMidi.push(finalAscendingTonicMidi);
                }


                allAscendingNotesMidi.forEach((midiNote, index) => {
                    const noteName = Tone.Midi(midiNote).toNote(); // Convert to note string here
                    const duration = (index === 0 || isScaleTonic(midiNote)) ? longTonicDuration : baseNoteDuration;
                    sequenceData.push({ notes: [noteName], duration: duration });
                });

                let descendingMidiNotesOnly = [];

                // Start from the top tonic and go down using natural minor intervals,
                // ensuring the notes are within the correct octave range.
                let tempDescendingMidi = finalAscendingTonicMidi; // Top note of ascending scale
                while (tempDescendingMidi >= initialBaseMidi) {
                    if (tempDescendingMidi !== finalAscendingTonicMidi) { // Exclude the top tonic that was already part of ascending
                        descendingMidiNotesOnly.push(tempDescendingMidi);
                    }
                    // Find previous diatonic step in Natural Minor
                    let currentPc = tempDescendingMidi % 12;
                    let foundPrev = false;
                    for (let i = 1; i <= 12; i++) { // Look for previous note in scale
                        const prevMidi = tempDescendingMidi - i;
                        if (prevMidi < initialBaseMidi - 1) break; // Don't go below the lowest note
                        const prevPc = prevMidi % 12;
                        // Check if prevPc is diatonic to Natural Minor scale for the root of this melodic minor
                        const melodicRootPc = initialBaseMidi % 12;
                        const isPrevInNaturalMinor = scaleIntervals['natural minor'].includes((prevPc - melodicRootPc + 12) % 12);

                        if (isPrevInNaturalMinor) {
                            tempDescendingMidi = prevMidi;
                            foundPrev = true;
                            break;
                        }
                    }
                    if (!foundPrev && tempDescendingMidi > initialBaseMidi) { // Allow the loop to finish on the root
                        console.error("Could not find previous diatonic note in Natural Minor for melodic minor descent.");
                        break;
                    } else if (!foundPrev && tempDescendingMidi === initialBaseMidi) { // Reached the bottom
                        break;
                    }
                }
                descendingMidiNotesOnly.reverse(); // Because we added them in reverse order (high to low)

                descendingMidiNotesOnly.forEach((midiNote) => {
                    const noteName = Tone.Midi(midiNote).toNote(); // Convert to note string here
                    const duration = isScaleTonic(midiNote) ? longTonicDuration : baseNoteDuration;
                    sequenceData.push({ notes: [noteName], duration: duration });
                });

            } else if (type === 'arpeggio') {
                let arpeggioIntervals;
                if (originalString.includes("major arpeggio")) {
                    arpeggioIntervals = [0, 4, 7];
                } else { // Minor arpeggio
                    arpeggioIntervals = [0, 3, 7];
                }
                let currentMidi = initialBaseMidi;

                for (let o = 0; o < octaves; o++) {
                    for (let i = 0; i < arpeggioIntervals.length; i++) {
                        sequenceData.push({ notes: [Tone.Midi(currentMidi + arpeggioIntervals[i]).toNote()], duration: baseNoteDuration });
                    }
                    currentMidi += 12;
                }
                sequenceData.push({ notes: [Tone.Midi(initialBaseMidi + (octaves * 12)).toNote()], duration: baseNoteDuration }); // Top tonic

                const ascendingNotesCopy = sequenceData.map(item => item.notes[0]);
                for (let i = ascendingNotesCopy.length - 2; i >= 0; i--) {
                    sequenceData.push({ notes: [ascendingNotesCopy[i]], duration: baseNoteDuration });
                }

            } else if (type === 'chromatic') {
                const startMidi = initialBaseMidi;
                const endMidi = startMidi + (octaves * 12);

                for (let midi = startMidi; midi <= endMidi; midi++) {
                    sequenceData.push({ notes: [Tone.Midi(midi).toNote()], duration: baseNoteDuration }); // Convert to note string
                }
                for (let midi = endMidi - 1; midi >= startMidi; midi--) {
                    sequenceData.push({ notes: [Tone.Midi(midi).toNote()], duration: baseNoteDuration }); // Convert to note string
                }
            } else if (type === 'dominant 7th') {
                const dominant7thIntervals = [0, 4, 7, 10]; // Intervals for a Major-Minor 7th (Dominant 7th)
                let currentMidi = initialBaseMidi;

                for (let o = 0; o < octaves; o++) {
                    for (let i = 0; i < dominant7thIntervals.length; i++) {
                        const noteMidi = currentMidi + dominant7thIntervals[i];
                        sequenceData.push({ notes: [Tone.Midi(noteMidi).toNote()], duration: baseNoteDuration });
                    }
                    currentMidi += 12;
                }
                sequenceData.push({ notes: [Tone.Midi(initialBaseMidi + (octaves * 12)).toNote()], duration: baseNoteDuration }); // Top note of the arpeggio

                const ascendingNotesCopy = sequenceData.map(item => item.notes[0]);
                for (let i = ascendingNotesCopy.length - 2; i >= 0; i--) {
                    sequenceData.push({ notes: [ascendingNotesCopy[i]], duration: baseNoteDuration });
                }

                // Resolving tonic: find the closest root note (e.g., Bb for Dominant 7th in Bb) to the end of the arpeggio
                const topOfArpeggioMidi = Tone.Midi(ascendingNotesCopy[ascendingNotesCopy.length - 1]).toMidi();
                const resolvingRootPc = getNoteIndex(root); // Root of the KEY (e.g., Bb for Dominant 7th in Bb)

                let actualResolvingTonicMidi = topOfArpeggioMidi;
                let foundResolvingTonic = false;
                // Search downwards for the closest tonic of the resolving key
                for (let i = 0; i < 12; i++) {
                    if (((actualResolvingTonicMidi - i) % 12 + 12) % 12 === resolvingRootPc) {
                        actualResolvingTonicMidi -= i;
                        foundResolvingTonic = true;
                        break;
                    }
                }
                if (!foundResolvingTonic) { // If not found going down, try going up
                     actualResolvingTonicMidi = topOfArpeggioMidi;
                     for (let i = 0; i < 12; i++) {
                        if (((actualResolvingTonicMidi + i) % 12 + 12) % 12 === resolvingRootPc) {
                            actualResolvingTonicMidi += i;
                            foundResolvingTonic = true;
                            break;
                        }
                    }
                }


                sequenceData.push({ notes: [Tone.Midi(actualResolvingTonicMidi).toNote()], duration: baseNoteDuration });

            } else if (type === 'diminished 7th') {
                const dim7Intervals = [0, 3, 6, 9];
                let currentMidi = initialBaseMidi;

                for (let o = 0; o < octaves; o++) {
                    for (let i = 0; i < dim7Intervals.length; i++) {
                        sequenceData.push({ notes: [Tone.Midi(currentMidi + dim7Intervals[i]).toNote()], duration: baseNoteDuration });
                    }
                    currentMidi += 12;
                }
                sequenceData.push({ notes: [Tone.Midi(initialBaseMidi + (octaves * 12)).toNote()], duration: baseNoteDuration });

                const ascendingNotesCopy = sequenceData.map(item => item.notes[0]);
                for (let i = ascendingNotesCopy.length - 2; i >= 0; i--) {
                    sequenceData.push({ notes: [ascendingNotesCopy[i]], duration: baseNoteDuration });
                }
            }

            return sequenceData;
        }

        /**
         * Toggles the demonstration playback. If playing, stops it. If not, starts it.
         */
        async function toggleDemonstration() {
            console.log("toggleDemonstration called. Initial AudioContext state:", Tone.context.state);

            if (Tone.context.state !== 'running') {
                try {
                    console.log("Attempting to start/resume AudioContext from toggleDemonstration...");
                    await Tone.start();
                    audioContextStarted = true;
                    console.log("AudioContext state after attempt:", Tone.context.state);
                    if (Tone.context.state !== 'running') {
                        throw new Error("AudioContext failed to transition to 'running' state.");
                    }
                } catch (e) {
                    console.error("Error starting/resuming AudioContext:", e);
                    scaleDisplay.textContent = "Error: Audio blocked! Click here or refresh and allow sound.";
                    scaleDisplay.classList.add('text-red-600');
                    return;
                }
            }

            if (Tone.context.state === 'running') {
                if (isPlayingDemo) {
                    console.log("Stopping current demo.");
                    Tone.Transport.stop();
                    Tone.Transport.cancel();
                    isPlayingDemo = false;
                    demonstrationButton.textContent = "Play Demo";
                    demonstrationButton.disabled = false;
                    scaleDisplay.classList.remove('text-red-600');
                } else {
                    if (currentScaleSelected) {
                        scaleDisplay.classList.remove('text-red-600');
                        console.log("Preparing to play demo.");

                        const scaleObjectToPlay = currentAllScales.find(s => s.name === currentScaleSelected);
                        if (!scaleObjectToPlay) {
                            console.error(`Scale object not found for "${currentScaleSelected}" in currentAllScales.`);
                            scaleDisplay.textContent = `Error: Scale data missing for "${currentScaleSelected}".`;
                            scaleDisplay.classList.add('text-red-600');
                            return;
                        }

                        const parsedScale = parseScaleName(scaleObjectToPlay.name);
                        let typeKey = parsedScale.type;

                        // Map specific playback rules to tempo categories if needed
                        if (scaleObjectToPlay.playbackRule === 'simultaneousSixthsCMajor') {
                            typeKey = 'simultaneousSixthsCMajor';
                        } else if (scaleObjectToPlay.playbackRule === 'brokenStepsOctavesEMajor') {
                            typeKey = 'brokenStepsOctavesEMajor';
                        } else if (scaleObjectToPlay.playbackRule === 'brokenStepsThirdsEbMajor') {
                            typeKey = 'brokenStepsThirdsEbMajor';
                        } else if (scaleObjectToPlay.playbackRule === 'brokenStepsTetrachord6ths') {
                            typeKey = 'brokenStepsTetrachord6ths';
                        } else if (scaleObjectToPlay.playbackRule === 'brokenStepsFullScale6ths') {
                            typeKey = 'brokenStepsFullScale6ths';
                        } else if (scaleObjectToPlay.playbackRule === 'brokenStepsTetrachordOctaves') {
                            typeKey = 'brokenStepsTetrachordOctaves';
                        } else if (['major', 'natural minor', 'harmonic minor', 'melodic minor'].includes(typeKey)) {
                            typeKey = 'major'; // Default for general scales if not explicitly overridden
                        }


                        const bpmInfo = gradeDefaultTempi[currentGrade] ? gradeDefaultTempi[currentGrade][typeKey] : null;

                        if (!bpmInfo) {
                             console.warn(`No specific BPM info found for type ${typeKey} in grade ${currentGrade}. Using default 60 BPM.`);
                             Tone.Transport.bpm.value = 60;
                             bpmSlider.value = 60;
                             bpmValueDisplay.textContent = 60;
                        } else {
                            Tone.Transport.bpm.value = bpmInfo.bpm;
                            bpmSlider.value = bpmInfo.bpm;
                            bpmValueDisplay.textContent = bpmInfo.bpm;
                        }

                        const notesAndDurations = getScaleNotes(scaleObjectToPlay);

                        console.log(`DEBUG: Notes for "${currentScaleSelected}" (Tone.js format):`, JSON.stringify(notesAndDurations));

                        if (notesAndDurations.length === 0) {
                            console.warn("No notes to play for demonstration. This might be a parsing or generation error for:", currentScaleSelected);
                            scaleDisplay.textContent = `Error: No notes generated for "${currentScaleSelected}". Check console.`;
                            scaleDisplay.classList.add('text-red-600');
                            return;
                        }

                        console.log(`Playing demo for: ${currentScaleSelected}`, notesAndDurations);
                        demonstrationButton.textContent = "Stop";
                        demonstrationButton.disabled = false;

                        Tone.Transport.cancel();

                        let currentTime = 0;
                        notesAndDurations.forEach((event, index) => {
                            const durationInSeconds = Tone.Time(event.duration).toSeconds();
                            Tone.Transport.scheduleOnce((time) => {
                                console.log(`DEBUG: Triggering Note(s): ${JSON.stringify(event.notes)} at time ${time.toFixed(4)} for duration ${event.duration}`);
                                synth.triggerAttackRelease(event.notes, event.duration, time);
                            }, currentTime);
                            currentTime += durationInSeconds;
                        });

                        Tone.Transport.scheduleOnce(() => {
                            console.log("Demo sequence finished naturally.");
                            if (isPlayingDemo) {
                                toggleDemonstration();
                            }
                        }, currentTime + Tone.Time("16n").toSeconds());

                        Tone.Transport.start();
                        isPlayingDemo = true;

                    } else {
                        scaleDisplay.textContent = "Please select a scale first!";
                    }
                }
            } else {
                console.warn("AudioContext is not running, cannot play demo.");
                scaleDisplay.textContent = "Audio still blocked. Ensure site sound is enabled.";
                scaleDisplay.classList.add('text-red-600');
            }
        }

        /**
         * Calculates the average rating for a given scale.
         * Returns a default value (3) if no ratings exist, to avoid breaking sort.
         * @param {string} scaleName - The name of the scale.
         * @returns {number} The average rating (1-5) or 3 if no ratings.
         */
        function getAverageRating(scaleName) {
            const ratings = scaleRatings[scaleName];
            if (!ratings || ratings.length === 0) {
                return 3;
            }
            const sum = ratings.reduce((acc, rating) => acc + rating, 0);
            return sum / ratings.length;
        }

        /**
         * Renders (or re-renders) the list of all scales in the UI for the current grade, categorized.
         */
        function renderScalesList() {
            allScalesListContainer.innerHTML = '';

            let scalesToDisplay;
            const gradeNum = parseInt(currentGrade.replace('Grade ', ''));

            // Apply minorType filter only for grades 2-5
            if (gradeNum >= 2 && gradeNum <= 5) {
                scalesToDisplay = currentAllScales.filter(scaleObj => {
                    if (scaleObj.minorType) {
                        return scaleObj.minorType === selectedMinorType;
                    }
                    return true;
                });
            } else {
                // For other grades (1, 6, 7, 8), include all major/minor types present
                scalesToDisplay = [...currentAllScales];
            }


            if (scalesToDisplay.length === 0) {
                const noScalesMessage = document.createElement('div');
                noScalesMessage.textContent = "No scales available for the current selection.";
                noScalesMessage.classList.add('p-2', 'text-gray-500', 'text-center');
                allScalesListContainer.appendChild(noScalesMessage);
                return;
            }

            // Categorize the filtered scales
            const categorizedScales = {
                "Major & Minor Scales": [],
                "Chromatic, Dominant & Diminished": [],
                "Arpeggios": [],
                "Double Stop Scales": []
            };

            scalesToDisplay.forEach(scaleObj => {
                const parsed = parseScaleName(scaleObj.name);
                if (!parsed) {
                    console.warn(`Could not parse scale type for categorization: ${scaleObj.name}`);
                    return;
                }
                const type = parsed.type;
                const playbackRule = scaleObj.playbackRule;

                if (['major', 'natural minor', 'harmonic minor', 'melodic minor'].includes(type)) {
                    categorizedScales["Major & Minor Scales"].push(scaleObj);
                } else if (['chromatic', 'dominant 7th', 'diminished 7th'].includes(type)) {
                    categorizedScales["Chromatic, Dominant & Diminished"].push(scaleObj);
                } else if (type === 'arpeggio') {
                    categorizedScales["Arpeggios"].push(scaleObj);
                } else if (
                    playbackRule === 'brokenStepsTetrachord6ths' ||
                    playbackRule === 'brokenStepsFullScale6ths' ||
                    playbackRule === 'brokenStepsTetrachordOctaves' ||
                    playbackRule === 'simultaneousSixthsCMajor' || // New rule
                    playbackRule === 'brokenStepsOctavesEMajor' ||  // New rule
                    playbackRule === 'brokenStepsThirdsEbMajor'     // New rule
                ) {
                    categorizedScales["Double Stop Scales"].push(scaleObj);
                } else {
                    console.warn(`Scale "${scaleObj.name}" did not fit into any defined category.`);
                }
            });

            // Render categories and their scales with BPM info
            for (const category in categorizedScales) {
                if (categorizedScales[category].length > 0) {
                    const categoryHeading = document.createElement('h3');
                    let tempoInfo = '';

                    const gradeTempi = gradeDefaultTempi[currentGrade];
                    if (gradeTempi) {
                        if (category === "Major & Minor Scales" && gradeTempi.major) {
                            tempoInfo = ` (${gradeTempi.major.displayTempo})`;
                        } else if (category === "Arpeggios" && gradeTempi.arpeggio) {
                            tempoInfo = ` (${gradeTempi.arpeggio.displayTempo})`;
                        } else if (category === "Chromatic, Dominant & Diminished") {
                            const typesInThisCategory = categorizedScales[category].map(s => parseScaleName(s.name).type);
                            if (typesInThisCategory.includes('chromatic') && gradeTempi.chromatic) {
                                tempoInfo = ` (${gradeTempi.chromatic.displayTempo})`;
                            } else if (typesInThisCategory.includes('dominant 7th') && gradeTempi['dominant 7th']) {
                                tempoInfo = ` (${gradeTempi['dominant 7th'].displayTempo})`;
                            } else if (typesInThisCategory.includes('diminished 7th') && gradeTempi['diminished 7th']) {
                                tempoInfo = ` (${gradeTempi['diminished 7th'].displayTempo})`;
                            }
                        } else if (category === "Double Stop Scales") {
                            // Check for specific playback rules within Double Stop Scales
                            const hasSimultaneousSixths = categorizedScales[category].some(s => s.playbackRule === 'simultaneousSixthsCMajor');
                            const hasBrokenStepsOctaves = categorizedScales[category].some(s => s.playbackRule === 'brokenStepsOctavesEMajor');
                            const hasBrokenStepsThirds = categorizedScales[category].some(s => s.playbackRule === 'brokenStepsThirdsEbMajor');
                            const hasTetrachord6ths = categorizedScales[category].some(s => s.playbackRule === 'brokenStepsTetrachord6ths');
                            const hasFullScale6ths = categorizedScales[category].length > 0 && categorizedScales[category][0].playbackRule === 'brokenStepsFullScale6ths';
                            const hasTetrachordOctaves = categorizedScales[category].some(s => s.playbackRule === 'brokenStepsTetrachordOctaves');

                            if (hasSimultaneousSixths && gradeTempi.simultaneousSixthsCMajor) {
                                tempoInfo = ` (${gradeTempi.simultaneousSixthsCMajor.displayTempo})`;
                            } else if (hasBrokenStepsOctaves && gradeTempi.brokenStepsOctavesEMajor) {
                                tempoInfo = ` (${gradeTempi.brokenStepsOctavesEMajor.displayTempo})`;
                            } else if (hasBrokenStepsThirds && gradeTempi.brokenStepsThirdsEbMajor) {
                                tempoInfo = ` (${gradeTempi.brokenStepsThirdsEbMajor.displayTempo})`;
                            } else if (hasTetrachord6ths && gradeTempi.brokenStepsTetrachord6ths) {
                                tempoInfo = ` (${gradeTempi.brokenStepsTetrachord6ths.displayTempo})`;
                            } else if (hasFullScale6ths && gradeTempi.brokenStepsFullScale6ths) {
                                tempoInfo = ` (${gradeTempi.brokenStepsFullScale6ths.displayTempo})`;
                            } else if (hasTetrachordOctaves && gradeTempi.brokenStepsTetrachordOctaves) {
                                tempoInfo = ` (${gradeTempi.brokenStepsTetrachordOctaves.displayTempo})`;
                            }
                        }
                    }

                    categoryHeading.textContent = `${category}${tempoInfo}`;
                    categoryHeading.classList.add('category-heading', 'w-full', 'col-span-1', 'sm:col-span-2');
                    allScalesListContainer.appendChild(categoryHeading);

                    categorizedScales[category].forEach(scaleObj => {
                        const scaleName = scaleObj.name;
                        const scaleItem = document.createElement('div');
                        const avgRating = getAverageRating(scaleName);
                        const ratingText = scaleRatings[scaleName] && scaleRatings[scaleName].length > 0 ? `(Avg: ${avgRating.toFixed(1)}/5)` : '';

                        scaleItem.textContent = `${scaleName} ${ratingText}`;
                        scaleItem.classList.add(
                            'p-2', 'bg-white', 'rounded-md', 'shadow-sm',
                            'text-gray-700', 'text-left', 'text-base', 'sm:text-lg',
                            'font-medium', 'transition-all', 'duration-200',
                            'flex', 'justify-between', 'items-center'
                        );

                        const isUsedInCurrentRandomRound = !isPracticeMode && !availableScales.some(s => s.name === scaleName);

                        if (isUsedInCurrentRandomRound) {
                            scaleItem.classList.add('greyed-out');
                        } else if (isPracticeMode) {
                            scaleItem.classList.add('clickable-scale-item');
                            scaleItem.classList.remove('greyed-out');
                            scaleItem.onclick = () => selectPracticeScale(scaleName);
                        } else {
                            scaleItem.classList.remove('clickable-scale-item');
                            scaleItem.onclick = null;
                        }

                        allScalesListContainer.appendChild(scaleItem);
                    });
                }
            }
        }

        /**
         * Shows the congratulations modal with scales sorted by difficulty for the current grade.
         */
        function showCongratulationsPopup() {
            modalScalesList.innerHTML = '';

            const sortedScales = [...currentAllScales].sort((a, b) => {
                const ratingA = getAverageRating(a.name);
                const ratingB = getAverageRating(b.name);
                return ratingA - ratingB;
            });

            const ul = document.createElement('ul');
            ul.classList.add('list-disc', 'list-inside', 'space-y-1');

            sortedScales.forEach(scaleObj => {
                const scaleName = scaleObj.name;
                const li = document.createElement('li');
                const avgRating = getAverageRating(scaleName);
                const ratingText = scaleRatings[scaleName] && scaleRatings[scaleName].length > 0 ? `(Avg: ${avgRating.toFixed(1)}/5)` : '(No ratings yet)';
                li.textContent = `${scaleName} ${ratingText}`;
                ul.appendChild(li);
            });
            modalScalesList.appendChild(ul);

            congratulationsModal.classList.remove('hidden');
        }

        /**
         * Hides the congratulations modal and resets the game state for a new random round.
         */
        function hideCongratulationsPopup() {
            congratulationsModal.classList.add('hidden');
            isFirstRandomRoundCompleted = true;
            resetRandomRound();
        }

        /**
         * Resets the available scales for a new random round for the current grade, applying the minor type filter.
         */
        function resetRandomRound() {
            let scalesToFilter = [...currentAllScales];
            const gradeNum = parseInt(currentGrade.replace('Grade ', ''));

            if (gradeNum >= 2 && gradeNum <= 5) {
                scalesToFilter = scalesToFilter.filter(scaleObj => {
                    if (scaleObj.minorType) {
                        return scaleObj.minorType === selectedMinorType;
                    }
                    return true;
                });
            }

            if (isFirstRandomRoundCompleted) {
                availableScales = [...scalesToFilter].sort((a, b) => {
                    const ratingA = getAverageRating(a.name);
                    const ratingB = getAverageRating(b.name);
                    return ratingA - ratingB;
                });
                console.log("Scales sorted for next random round based on ratings:", availableScales.map(s => s.name));
            } else {
                availableScales = [...scalesToFilter];
            }
            renderScalesList();
        }

        /**
         * Selects a random scale from the availableScales array for random mode.
         * @returns {object|null} The chosen scale object, or null if all scales are done.
         */
        function selectRandomScale() {
            if (availableScales.length === 0) {
                showCongratulationsPopup();
                return null;
            }

            let randomIndex;
            let chosenScaleObj;

            do {
                randomIndex = Math.floor(Math.random() * availableScales.length);
                chosenScaleObj = availableScales[randomIndex];
            } while (chosenScaleObj && previousScale && chosenScaleObj.name === previousScale.name && availableScales.length > 1);

            availableScales.splice(randomIndex, 1);
            previousScale = chosenScaleObj;
            renderScalesList();
            return chosenScaleObj;
        }

        /**
         * Handles selecting a scale when in practice mode.
         * @param {string} scaleName - The name of the scale clicked.
         */
        function selectPracticeScale(scaleName) {
            if (isPlayingDemo) {
                toggleDemonstration();
            }

            scaleDisplay.textContent = scaleName;
            currentScaleSelected = scaleName;

            const scaleObjectToPlay = currentAllScales.find(s => s.name === currentScaleSelected);
            if (!scaleObjectToPlay) {
                console.error(`Scale object not found for "${currentScaleSelected}" in currentAllScales.`);
                scaleDisplay.textContent = `Error: Scale data missing for "${currentScaleSelected}".`;
                scaleDisplay.classList.add('text-red-600');
                return;
            }
            const parsedScale = parseScaleName(scaleObjectToPlay.name);
            let typeKey = parsedScale.type;

            // Map specific playback rules to tempo categories if needed
            if (scaleObjectToPlay.playbackRule === 'simultaneousSixthsCMajor') {
                typeKey = 'simultaneousSixthsCMajor';
            } else if (scaleObjectToPlay.playbackRule === 'brokenStepsOctavesEMajor') {
                typeKey = 'brokenStepsOctavesEMajor';
            } else if (scaleObjectToPlay.playbackRule === 'brokenStepsThirdsEbMajor') {
                typeKey = 'brokenStepsThirdsEbMajor';
            } else if (scaleObjectToPlay.playbackRule === 'brokenStepsTetrachord6ths') {
                typeKey = 'brokenStepsTetrachord6ths';
            } else if (scaleObjectToPlay.playbackRule === 'brokenStepsFullScale6ths') {
                typeKey = 'brokenStepsFullScale6ths';
            } else if (scaleObjectToPlay.playbackRule === 'brokenStepsTetrachordOctaves') {
                typeKey = 'brokenStepsTetrachordOctaves';
            } else if (['major', 'natural minor', 'harmonic minor', 'melodic minor'].includes(typeKey)) {
                typeKey = 'major'; // Default for general scales if not explicitly overridden
            }


            const bpmInfo = gradeDefaultTempi[currentGrade] ? gradeDefaultTempi[currentGrade][typeKey] : null;

            if (bpmInfo) {
                Tone.Transport.bpm.value = bpmInfo.bpm;
                bpmSlider.value = bpmInfo.bpm;
                bpmValueDisplay.textContent = bpmInfo.bpm;
            } else {
                Tone.Transport.bpm.value = 60;
                bpmSlider.value = 60;
                bpmValueDisplay.textContent = 60;
            }

            gimmeScaleButton.classList.add('hidden');
            actionContainer.classList.remove('hidden');
            demonstrationButton.textContent = "Play Demo";
            stars.forEach(star => star.classList.remove('selected'));

            scaleDisplay.classList.remove('animate-pulse');
            void scaleDisplay.offsetWidth;
            scaleDisplay.classList.add('animate-pulse');
            setTimeout(() => {
                scaleDisplay.classList.remove('animate-pulse');
            }, 500);
        }

        /**
         * Handles grade selection.
         * @param {string} grade - The selected grade (e.g., "Grade 1").
         */
        async function selectGrade(grade) {
            currentGrade = grade;
            mainTitle.textContent = `Grade ${grade.replace('Grade ', '')} Scale Practise App`;

            currentAllScales = allGradeScales[grade];

            scaleRatings = {};
            currentAllScales.forEach(scaleObj => {
                scaleRatings[scaleObj.name] = [];
            });

            previousScale = null;
            currentScaleSelected = null;
            isFirstRandomRoundCompleted = false;

            scaleDisplay.textContent = "Click 'Gimme a Scale!' to start!";
            actionContainer.classList.add('hidden');
            gimmeScaleButton.classList.remove('hidden');
            isPracticeMode = false;

            gradeSelectionScreen.classList.add('hidden');
            practiceScreen.classList.remove('hidden');
            practiceScreen.style.display = 'flex';

            const gradeTempi = gradeDefaultTempi[currentGrade];
            if (gradeTempi && gradeTempi.major) {
                Tone.Transport.bpm.value = gradeTempi.major.bpm;
                bpmSlider.value = gradeTempi.major.bpm;
                bpmValueDisplay.textContent = gradeTempi.major.bpm;
            } else {
                Tone.Transport.bpm.value = 60;
                bpmSlider.value = 60;
                bpmValueDisplay.textContent = 60;
            }


            const gradeNum = parseInt(grade.replace('Grade ', ''));
            if (gradeNum >= 2 && gradeNum <= 5) {
                await showMinorSelectionModal();
            } else {
                resetRandomRound();
            }
        }

        /**
         * Displays the modal for selecting harmonic or melodic minor scales for grades 2-5.
         * @returns {Promise<void>} A promise that resolves when a selection is made or the modal is closed.
         */
        function showMinorSelectionModal() {
            return new Promise((resolve) => {
                minorSelectionModal.classList.remove('hidden');

                const handleSelection = (type) => {
                    selectedMinorType = type;
                    minorSelectionModal.classList.add('hidden');
                    resetRandomRound();
                    resolve();
                };

                harmonicButton.onclick = () => handleSelection('harmonic');
                melodicButton.onclick = () => handleSelection('melodic');
                closeMinorSelectionModalButton.onclick = () => {
                    selectedMinorType = 'harmonic';
                    minorSelectionModal.classList.add('hidden');
                    resetRandomRound();
                    resolve();
                };
            });
        }

        /**
         * Dynamically creates the grade selection buttons.
         */
        function createGradeButtons() {
            for (let i = 1; i <= 8; i++) {
                const button = document.createElement('button');
                button.textContent = `Grade ${i}`;
                button.classList.add(
                    'bg-blue-500', 'hover:bg-blue-600', 'text-white', 'font-bold',
                    'py-3', 'px-6', 'rounded-full', 'shadow-lg', 'hover:shadow-xl',
                    'transition', 'duration-300', 'ease-in-out', 'transform', 'hover:-translate-y-1',
                    'focus:outline-none', 'focus:ring-4', 'focus:ring-blue-300', 'focus:ring-opacity-75',
                    'text-xl'
                );
                button.onclick = () => selectGrade(`Grade ${i}`);
                gradeButtonsContainer.appendChild(button);
            }
        }

        // --- Event Listeners ---

        gimmeScaleButton.addEventListener('click', () => {
            console.log("Gimme Scale button clicked!");
            if (isPlayingDemo) {
                toggleDemonstration();
            }

            const scaleObj = selectRandomScale();
            if (scaleObj) {
                scaleDisplay.textContent = scaleObj.name;
                currentScaleSelected = scaleObj.name;

                gimmeScaleButton.classList.add('hidden');
                actionContainer.classList.remove('hidden');
                demonstrationButton.textContent = "Play Demo";
                stars.forEach(star => star.classList.remove('selected'));

                scaleDisplay.classList.remove('animate-pulse');
                void scaleDisplay.offsetWidth;
                scaleDisplay.classList.add('animate-pulse');
                setTimeout(() => {
                    scaleDisplay.classList.remove('animate-pulse');
                }, 500);
            }
        });

        togglePracticeModeButton.addEventListener('click', async () => {
            console.log("Toggle Practise Mode button clicked!");
            if (isPlayingDemo) {
                toggleDemonstration();
            }

            if (Tone.context.state !== 'running') {
                try {
                    console.log("Attempting to start/resume AudioContext from Toggle Practise Mode...");
                    await Tone.start();
                    audioContextStarted = true;
                    console.log("AudioContext state after Toggle Practise Mode attempt:", Tone.context.state);
                } catch (e) {
                    console.error("Error starting/resuming AudioContext from Toggle Practise Mode:", e);
                    scaleDisplay.textContent = "Audio blocked! Please ensure sound is allowed for this site.";
                    scaleDisplay.classList.add('text-red-600');
                }
            }

            isPracticeMode = !isPracticeMode;
            if (isPracticeMode) {
                gimmeScaleButton.classList.add('hidden');
                actionContainer.classList.add('hidden');
                scaleDisplay.textContent = "Select a scale from the list below!";
            } else {
                gimmeScaleButton.classList.remove('hidden');
                scaleDisplay.textContent = "Click 'Gimme a Scale!' to start!";
            }
            renderScalesList();
        });

        demonstrationButton.addEventListener('click', toggleDemonstration);

        bpmSlider.addEventListener('input', () => {
            Tone.Transport.bpm.value = bpmSlider.value;
            bpmValueDisplay.textContent = bpmSlider.value;
            console.log("BPM set to:", bpmSlider.value);
        });

        volumeSlider.addEventListener('input', () => {
            const sliderValue = parseInt(volumeSlider.value);
            volumeValueDisplay.textContent = sliderValue;

            if (sliderValue === 0) {
                Tone.Destination.volume.value = -Infinity;
            } else {
                const minDb = -60;
                const maxDb = 0;
                const dbValue = (sliderValue / 100) * (maxDb - minDb) + minDb;
                Tone.Destination.volume.value = dbValue;
            }
            console.log("Volume set to:", sliderValue, "%, calculated dB:", Tone.Destination.volume.value);
        });


        stars.forEach(star => {
            star.addEventListener('mouseover', () => {
                const value = parseInt(star.dataset.value);
                stars.forEach((s, i) => {
                    if (i < value) {
                        s.classList.add('hovered');
                    } else {
                        s.classList.remove('hovered');
                    }
                });
            });

            star.addEventListener('mouseout', () => {
                stars.forEach(s => s.classList.remove('hovered'));
            });

            star.addEventListener('click', () => {
                const rating = parseInt(star.dataset.value);

                stars.forEach((s, i) => {
                    if (i < rating) {
                        s.classList.add('selected');
                    } else {
                        s.classList.remove('selected');
                    }
                });

                if (currentScaleSelected && scaleRatings[currentScaleSelected]) {
                    scaleRatings[currentScaleSelected].push(rating);
                    console.log(`Rated "${currentScaleSelected}" as ${rating} stars. All ratings:`, scaleRatings);
                }

                renderScalesList();

                if (isPlayingDemo) {
                    toggleDemonstration();
                }

                setTimeout(() => {
                    actionContainer.classList.add('hidden');
                    if (!isPracticeMode) {
                        gimmeScaleButton.classList.remove('hidden');
                    }
                }, 700);
            });
        });

        closeModalButton.addEventListener('click', hideCongratulationsPopup);

        backToGradesButton.addEventListener('click', () => {
            if (isPlayingDemo) {
                toggleDemonstration();
            }
            practiceScreen.classList.add('hidden');
            gradeSelectionScreen.classList.remove('hidden');
            mainTitle.textContent = "Elliot's Scale Practise App for MTB Viola Exams";
        });

        helpIcon.addEventListener('click', () => {
            helpModal.classList.remove('hidden');
        });

        closeHelpModalButton.addEventListener('click', () => {
            helpModal.classList.add('hidden');
        });


        // --- Initial Load Logic ---
        window.onload = () => {
            createGradeButtons();
            bpmValueDisplay.textContent = bpmSlider.value;
            volumeValueDisplay.textContent = volumeSlider.value;
            console.log("App loaded. Version: 2024-06-14-07-30");
        };
    </script>
</body>
</html>
