<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elliot's Scale Practice App for MTB Viola Exams</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN for audio synthesis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            flex-direction: column; /* Changed to column to stack main container and new button */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 700px; /* Slightly wider to accommodate the list better */
            width: 100%;
            text-align: center;
        }
        .scale-display {
            min-height: 80px; /* Ensure enough space for text */
        }
        .greyed-out {
            opacity: 0.5;
            text-decoration: line-through;
            color: #6b7280; /* Tailwind gray-500 */
        }
        .clickable-scale-item {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .clickable-scale-item:hover {
            background-color: #e2e8f0; /* Tailwind gray-200 */
        }
        /* Custom scrollbar for the scales list */
        .scales-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .scales-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scales-list-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Tailwind gray-300 */
            border-radius: 10px;
        }
        .scales-list-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Tailwind gray-400 */
        }

        /* Star rating styles */
        .star-rating .star {
            cursor: pointer;
            font-size: 2.5rem; /* Larger stars */
            color: #ccc; /* Default grey */
            transition: color 0.2s ease-in-out, transform 0.1s ease-in-out;
            display: inline-block; /* Allow horizontal alignment */
            margin: 0 0.2rem; /* Space between stars */
        }
        .star-rating .star:hover {
            transform: scale(1.1);
        }
        .star-rating .star.selected {
            color: #facc15; /* Tailwind amber-400 */
        }
        .star-rating .star.hovered {
            color: #facc15; /* Tailwind amber-400 */
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2.5rem;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.25);
            text-align: center;
            max-width: 90%;
            width: 500px; /* Wider for the list */
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="selection:bg-cyan-200">
    <div class="container flex flex-col items-center justify-center p-6 sm:p-8 md:p-10">
        <h1 id="mainTitle" class="text-3xl sm:text-4xl font-bold text-gray-800 mb-6">Elliot's Scale Practice App for MTB Viola Exams</h1>

        <!-- Grade Selection Screen -->
        <div id="gradeSelectionScreen" class="w-full flex flex-col items-center justify-center">
            <p class="text-lg text-gray-600 mb-8">Select the exam grade you're working towards:</p>
            <div id="gradeButtonsContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-4 w-full max-w-lg">
                <!-- Grade buttons will be inserted here by JavaScript -->
            </div>
        </div>

        <!-- Main Practice Screen -->
        <div id="practiceScreen" class="w-full hidden flex-col items-center justify-center">
            <p class="text-lg text-gray-600 mb-8">Click the button below to get a random scale or arpeggio to practice!</p>

            <div id="scaleDisplay" class="scale-display text-4xl sm:text-5xl font-extrabold text-teal-600 mb-10 flex items-center justify-center min-h-[100px] text-center p-4 bg-teal-50 rounded-lg shadow-inner w-full break-words leading-tight">
                Your next challenge awaits!
            </div>

            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-10 w-full max-w-xs">
                <button id="gimmeScaleButton" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-teal-300 focus:ring-opacity-75 text-xl sm:text-2xl w-full">
                    Gimme a Scale!
                </button>
                <button id="togglePracticeModeButton" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-6 rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-purple-300 focus:ring-opacity-75 text-lg sm:text-xl w-full">
                    Toggle Practice Mode
                </button>
            </div>

            <!-- BPM Slider -->
            <div class="w-full max-w-md flex flex-col items-center justify-center mb-6">
                <label for="bpmSlider" class="text-lg font-semibold text-gray-700 mb-2">
                    Playback Speed: <span id="bpmValueDisplay">50</span> BPM (crotchet)
                </label>
                <input type="range" id="bpmSlider" min="30" max="120" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
            </div>

            <!-- Volume Slider -->
            <div class="w-full max-w-md flex flex-col items-center justify-center mb-10">
                <label for="volumeSlider" class="text-lg font-semibold text-gray-700 mb-2">
                    Volume: <span id="volumeValueDisplay">100</span>%
                </label>
                <input type="range" id="volumeSlider" min="0" max="100" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
            </div>

            <!-- Container for Demonstration Button and Star Rating -->
            <div id="actionContainer" class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-10 hidden">
                <button id="demonstrationButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-75 text-lg sm:text-xl">
                    Play Demo
                </button>
                <div id="starRatingContainer" class="star-rating">
                    <span class="star" data-value="1">&#9733;</span>
                    <span class="star" data-value="2">&#9733;</span>
                    <span class="star" data-value="3">&#9733;</span>
                    <span class="star" data-value="4">&#9733;</span>
                    <span class="star" data-value="5">&#9733;</span>
                    <p class="text-gray-500 text-sm mt-2">Rate how well you played (1=Hardest, 5=Easiest)</p>
                </div>
            </div>

            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mt-10 mb-4">All Scales & Arpeggios</h2>
            <div id="allScalesList" class="scales-list-container grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4 p-4 bg-gray-50 rounded-lg shadow-inner w-full max-h-60 overflow-y-auto">
                <!-- Scale items will be dynamically inserted here by JavaScript -->
            </div>
            <button id="backToGradesButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 ease-in-out mt-8">
                Back to Grades
            </button>
        </div>
    </div>

    <!-- "Made by Elliot Corner" Button -->
    <a href="http://www.elliotviola.co.uk/" target="_blank" rel="noopener noreferrer"
       class="mt-8 px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-full shadow-lg
              hover:from-blue-600 hover:to-indigo-700 transition duration-300 ease-in-out transform hover:scale-105
              focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-75 text-lg flex items-center justify-center">
        Made by Elliot Corner
    </a>


    <!-- Congratulations Modal -->
    <div id="congratulationsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-3xl font-bold text-teal-600 mb-4">Congratulations!</h3>
            <p class="text-xl text-gray-700 mb-6">Well done! You've completed a round of scales. Here's what to practice next!</p>
            <h4 class="text-lg font-semibold text-gray-800 mb-2">Scales Ordered by Difficulty (Hardest to Easiest):</h4>
            <div id="modalScalesList" class="text-left text-gray-700 max-h-40 overflow-y-auto mb-6 p-2 border border-gray-200 rounded-md">
                <!-- Scales will be inserted here dynamically -->
            </div>
            <button id="closeModalButton" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 ease-in-out">
                Awesome!
            </button>
        </div>
    </div>

    <script>
        // --- Grade-specific Scale Data ---
        const allGradeScales = {
            'Grade 1': [
                "C major scale - 1 octave",
                "G major scale - 1 octave",
                "D major scale - 1 octave",
                "A natural minor scale - 1 octave",
                "C major arpeggio - 1 octave",
                "G major arpeggio - 1 octave",
                "D major arpeggio - 1 octave",
                "A minor arpeggio - 1 octave"
            ],
            'Grade 2': [
                "F major scale - 2 octaves",
                "Bb major scale - 2 octaves",
                "E harmonic minor scale - 2 octaves",
                "D melodic minor scale - 2 octaves",
                "F major arpeggio - 2 octaves",
                "Bb major arpeggio - 2 octaves",
                "E minor arpeggio - 2 octaves",
                "D minor arpeggio - 2 octaves"
            ],
            'Grade 3': [
                "A major scale - 2 octaves",
                "Eb major scale - 2 octaves",
                "C harmonic minor scale - 2 octaves",
                "G melodic minor scale - 2 octaves",
                "A major arpeggio - 2 octaves",
                "Eb major arpeggio - 2 octaves",
                "C minor arpeggio - 2 octaves",
                "G minor arpeggio - 2 octaves",
                "Chromatic Scale on C - 2 octaves"
            ],
            'Grade 4': [
                "G major scale - 2 octaves",
                "Ab major scale - 2 octaves",
                "D harmonic minor scale - 2 octaves",
                "F melodic minor scale - 2 octaves",
                "G major arpeggio - 2 octaves",
                "Ab major arpeggio - 2 octaves",
                "D minor arpeggio - 2 octaves",
                "F minor arpeggio - 2 octaves",
                "Chromatic Scale on Eb - 2 octaves",
                "Dominant 7th in C - 1 octave",
                "Diminished 7th on F# - 1 octave"
            ],
            'Grade 5': [
                "B major scale - 2 octaves",
                "Db major scale - 2 octaves",
                "G harmonic minor scale - 2 octaves",
                "A melodic minor scale - 2 octaves",
                "B major arpeggio - 2 octaves",
                "Db major arpeggio - 2 octaves",
                "G minor arpeggio - 2 octaves",
                "A minor arpeggio - 2 octaves",
                "Chromatic Scale on D - 2 octaves",
                "Dominant 7th in G - 2 octaves",
                "Diminished 7th on C - 2 octaves"
            ],
            'Grade 6': [
                "E major scale - 3 octaves",
                "Bb major scale - 3 octaves",
                "C harmonic minor scale - 3 octaves",
                "F# melodic minor scale - 3 octaves",
                "E major arpeggio - 3 octaves",
                "Bb major arpeggio - 3 octaves",
                "C minor arpeggio - 3 octaves",
                "F# minor arpeggio - 3 octaves",
                "Chromatic Scale on A - 3 octaves",
                "Dominant 7th in Eb - 2 octaves",
                "Diminished 7th on D - 2 octaves"
            ],
            'Grade 7': [
                "Eb major scale - 3 octaves",
                "F# harmonic minor scale - 3 octaves",
                "Eb melodic minor scale - 3 octaves",
                "Eb major arpeggio - 3 octaves",
                "F# minor arpeggio - 3 octaves",
                "Eb minor arpeggio - 3 octaves",
                "Chromatic Scale on G - 3 octaves",
                "Dominant 7th in C - 2 octaves",
                "Diminished 7th on F# - 2 octaves",
                "G major scale in 6ths - 2 octaves",
                "Bb Major Tetrachord in octaves"
            ],
            'Grade 8': [
                "F major scale - 3 octaves",
                "C# harmonic minor scale - 3 octaves",
                "Bb melodic minor scale - 3 octaves",
                "F major arpeggio - 3 octaves",
                "C# minor arpeggio - 3 octaves",
                "Bb minor arpeggio - 3 octaves",
                "Chromatic Scale on A - 3 octaves",
                "Dominant 7th in Ab - 2 octaves",
                "Diminished 7th on D - 2 octaves",
                "C minor scale in 6ths - 2 octaves",
                "Db Major Tetrachord in octaves"
            ]
        };

        let currentAllScales = []; // This will hold the scales for the currently selected grade
        let scaleRatings = {}; // Ratings for the current grade
        let availableScales = [];
        let previousScale = null;
        let currentScaleSelected = null;
        let isFirstRandomRoundCompleted = false;
        let audioContextStarted = false;
        let isPlayingDemo = false;
        let isPracticeMode = false;
        let currentGrade = null; // Stores the currently selected grade

        // UI Element References
        const mainTitle = document.getElementById('mainTitle');
        const gradeSelectionScreen = document.getElementById('gradeSelectionScreen');
        const gradeButtonsContainer = document.getElementById('gradeButtonsContainer');
        const practiceScreen = document.getElementById('practiceScreen');
        const scaleDisplay = document.getElementById('scaleDisplay');
        const gimmeScaleButton = document.getElementById('gimmeScaleButton');
        const togglePracticeModeButton = document.getElementById('togglePracticeModeButton');
        const bpmSlider = document.getElementById('bpmSlider');
        const bpmValueDisplay = document.getElementById('bpmValueDisplay');
        const volumeSlider = document.getElementById('volumeSlider'); // New
        const volumeValueDisplay = document.getElementById('volumeValueDisplay'); // New
        const allScalesListContainer = document.getElementById('allScalesList');
        const actionContainer = document.getElementById('actionContainer');
        const demonstrationButton = document.getElementById('demonstrationButton');
        const starRatingContainer = document.getElementById('starRatingContainer');
        const stars = document.querySelectorAll('.star-rating .star');
        const congratulationsModal = document.getElementById('congratulationsModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalScalesList = document.getElementById('modalScalesList');
        const backToGradesButton = document.getElementById('backToGradesButton');

        // Tone.js Setup
        const synth = new Tone.PolySynth(Tone.Synth, {
            envelope: {
                attack: 0.02,   // Quick attack for immediate sound
                decay: 0.3,     // Moderate decay to the sustain level
                sustain: 0.1,   // Hold sound at 10% volume after decay
                release: 0.3,   // Fade out over 0.3 seconds after the note ends
            },
            oscillator: {
                type: "triangle"
            }
        }).toDestination();

        Tone.Transport.bpm.value = bpmSlider.value;
        // Set initial volume for Tone.js to 0dB (corresponds to 100% on slider)
        Tone.Destination.volume.value = 0;
        let currentSequence = null;

        // --- Note Mapping for Sharps and Flats ---
        const noteMap = {
            "C": 0, "C#": 1, "DB": 1,
            "D": 2, "D#": 3, "EB": 3,
            "E": 4, "F": 5, "F#": 6, "GB": 6,
            "G": 7, "G#": 8, "AB": 8,
            "A": 9, "A#": 10, "BB": 10,
            "B": 11
        };

        const noteNamesByIndex = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

        function getNoteIndex(noteString) {
            if (!noteString) return -1;
            const upperCaseNote = noteString.toUpperCase();
            return noteMap[upperCaseNote] !== undefined ? noteMap[upperCaseNote] : -1;
        }
        // --- End Note Mapping ---

        const scaleIntervals = {
            'major': [0, 2, 4, 5, 7, 9, 11],
            'natural minor': [0, 2, 3, 5, 7, 8, 10], // Natural minor intervals
            'harmonic minor': [0, 2, 3, 5, 7, 8, 11],
            'melodic minor': [0, 2, 3, 5, 7, 9, 11], // Ascending
            'chromatic': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
        };

        /**
         * Parses the scale name string to extract root, type, and octaves.
         * @param {string} scaleName - The full scale name string.
         * @returns {object|null} An object with root, type, and octaves, or null if parsing fails.
         */
        function parseScaleName(scaleName) {
            const lowerCaseName = scaleName.toLowerCase();
            const parts = lowerCaseName.split(' ');

            let root = '';
            let type = '';
            let octaves = 1;

            if (lowerCaseName.includes("dominant 7th in")) {
                const inIndex = parts.indexOf('in');
                if (inIndex !== -1 && parts.length > inIndex + 1) {
                    root = parts[inIndex + 1].toUpperCase();
                } else {
                    console.error(`Could not parse key tonic for dominant 7th: ${scaleName}`);
                    return null;
                }
                type = 'dominant 7th';
            } else if (lowerCaseName.includes("diminished 7th on")) {
                const onIndex = parts.indexOf('on');
                if (onIndex !== -1 && parts.length > onIndex + 1) {
                    root = parts[onIndex + 1].toUpperCase();
                } else {
                    console.error(`Could not parse root for diminished 7th: ${scaleName}`);
                    return null;
                }
                type = 'diminished 7th';
            } else if (lowerCaseName.includes("scale in 6ths")) {
                root = parts[0].toUpperCase();
                type = 'scale in 6ths';
            } else if (lowerCaseName.includes("tetrachord in octaves")) {
                root = parts[0].toUpperCase();
                type = 'tetrachord in octaves';
                octaves = 1; // Tetrachord specific logic handles its length
            } else if (lowerCaseName.includes("chromatic scale on")) { // Added for chromatic scale root extraction
                const onIndex = parts.indexOf('on');
                if (onIndex !== -1 && parts.length > onIndex + 1) {
                    root = parts[onIndex + 1].toUpperCase();
                } else {
                    console.error(`Could not parse root for chromatic scale: ${scaleName}`);
                    return null;
                }
                type = 'chromatic';
            } else if (lowerCaseName.includes("natural minor scale")) { // Added for natural minor
                root = parts[0].toUpperCase();
                type = 'natural minor';
            }
            else {
                root = parts[0].toUpperCase();
                type = '';

                if (lowerCaseName.includes("major scale")) type = 'major';
                else if (lowerCaseName.includes("harmonic minor scale")) type = 'harmonic minor';
                else if (lowerCaseName.includes("melodic minor scale")) type = 'melodic minor';
                else if (lowerCaseName.includes("chromatic scale")) type = 'chromatic'; // This might be redundant if the "on" condition catches it.
                else if (lowerCaseName.includes("arpeggio")) type = 'arpeggio';
                else return null;
            }

            const octaveMatch = lowerCaseName.match(/(\d)\s*octaves?/);
            if (octaveMatch && octaveMatch[1]) {
                octaves = parseInt(octaveMatch[1]);
            }

            return { root, type, octaves, originalString: lowerCaseName };
        }

        /**
         * Generates an array of Tone.js note strings (e.g., "C4", "G#5") or arrays of note strings (for chords/double stops).
         * @param {string} scaleName - The name of the scale.
         * @returns {Array<string|string[]>} An array of note strings or arrays of note strings.
         */
        function getScaleNotes(scaleName) {
            const parsed = parseScaleName(scaleName);
            if (!parsed) return [];

            const { root, type, octaves, originalString } = parsed;
            let ascendingNotes = [];
            let fullScaleNotes = [];
            let baseOctave = 0; // Will be determined dynamically.

            let actualRootForGeneration = root; // This will be the note from which we generate the scale/arpeggio
            let keyTonicIndexForDominant7th = -1; // Declare keyTonicIndex in a higher scope

            // Determine the actual root note for generation based on scale type
            if (type === 'dominant 7th') {
                // For "Dominant 7th in G", the actual arpeggio starts on D (the dominant of G)
                // Get the index of the key tonic (e.g., G for "Dominant 7th in G")
                keyTonicIndexForDominant7th = getNoteIndex(root); // Assign value here
                if (keyTonicIndexForDominant7th === -1) {
                    console.error(`Invalid key tonic for dominant 7th: ${root}`);
                    return [];
                }
                // The dominant is 7 semitones above the tonic
                const dominantIndex = (keyTonicIndexForDominant7th + 7) % 12;
                actualRootForGeneration = noteNamesByIndex[dominantIndex];
            } else if (type === 'diminished 7th') {
                // For "Diminished 7th on D", the actual arpeggio starts on D
                actualRootForGeneration = root;
            } else if (type === 'chromatic') {
                // For "Chromatic Scale on D", the actual scale starts on D
                actualRootForGeneration = root;
            }
            // For major, minor, arpeggio, scale in 6ths, tetrachord, the root is the actual start note.

            let arpeggioOrScaleRootIndex = getNoteIndex(actualRootForGeneration);

            if (arpeggioOrScaleRootIndex === -1) {
                console.error(`Invalid root note index for generation: ${actualRootForGeneration} (derived from original: ${scaleName})`);
                return [];
            }

            // --- Dynamic Base Octave Determination for Viola (aligned with Tone.js notation) ---
            // Tone.js uses C4 as MIDI 60. Viola's open C string is C3 (MIDI 48).
            // So if baseToneJsOctave is 3, it refers to C3, G3, A3 etc.
            // If baseToneJsOctave is 4, it refers to D4, E4, F4 etc.

            if (type === 'scale in 6ths' || type === 'tetrachord in octaves') {
                // These have specific hardcoded notes/octaves, logic is already self-contained.
                // baseOctave variable is not used for these, their notes are explicitly defined.
            } else if (type === 'chromatic') {
                // Chromatic scales generally start higher for clarity and range.
                // For a D chromatic starting on D4 (MIDI 62):
                // D's root index is 2. To get MIDI 62: (2 + (baseOctave * 12)) = 62 => baseOctave * 12 = 60 => baseOctave = 5.
                baseOctave = 5; // Corresponds to Tone.js Octave 4 for D, E, F, etc.
            } else {
                // For single-note scales and arpeggios, assign the Tone.js octave number.
                const rootsPreferringToneJsOctave4Start = [
                    'D', 'D#', 'EB', // For D4, Eb4
                    'E', 'F', 'F#', 'GB', // For E4, F4, F#4, Gb4
                    'C#', 'DB', // For C#4, Db4
                    'Bb', 'B', // For Bb4, B4
                    'AB' // For Ab4
                ];

                if (rootsPreferringToneJsOctave4Start.includes(actualRootForGeneration)) {
                    baseOctave = 4; // These roots will typically start at Tone.js Octave 4 (e.g., D4, E4).
                                    // Example: For D (index 2), notes will be 2 + (4 * 12) = 50 (D4). This is the desired physical octave.
                } else {
                    // This covers C, G, A
                    baseOctave = 3; // These roots will typically start at Tone.js Octave 3 (e.g., C3, G3, A3).
                                    // Example: For C (index 0), notes will be 0 + (3 * 12) = 36 (C3). This is the desired physical octave.
                }

                // Special case for Dominant 7th in F, whose actualRootForGeneration is 'C'.
                // Normally 'C' would get baseOctave 3 (C3). But for this specific dominant 7th,
                // it is commonly played starting on C4.
                if (type === 'dominant 7th' && actualRootForGeneration === 'C') {
                    baseOctave = 4; // Override to make C start at Tone.js C4.
                                    // Example: For C (index 0), notes will be 0 + (4 * 12) = 48 (C4). Correct for this context.
                }
            }


            // --- Generate Notes based on Determined Base Octave ---
            if (type === 'major' || type === 'harmonic minor' || type === 'melodic minor' || type === 'natural minor') {
                const intervals = scaleIntervals[type];
                for (let o = 0; o < octaves; o++) {
                    for (let i = 0; i < intervals.length; i++) {
                        const midiNote = (arpeggioOrScaleRootIndex + intervals[i]) + (o * 12) + (baseOctave * 12);
                        ascendingNotes.push(Tone.Midi(midiNote).toNote());
                    }
                }
                const topOctaveRootMidi = (arpeggioOrScaleRootIndex) + (octaves * 12) + (baseOctave * 12);
                ascendingNotes.push(Tone.Midi(topOctaveRootMidi).toNote());

                fullScaleNotes = [...ascendingNotes];
                for (let i = ascendingNotes.length - 2; i >= 0; i--) {
                    fullScaleNotes.push(ascendingNotes[i]);
                }

            } else if (type === 'chromatic') {
                const startMidi = arpeggioOrScaleRootIndex + (baseOctave * 12);
                const endMidi = startMidi + (octaves * 12);

                for (let midi = startMidi; midi <= endMidi; midi++) {
                    ascendingNotes.push(Tone.Midi(midi).toNote());
                }

                fullScaleNotes = [...ascendingNotes];
                for (let i = ascendingNotes.length - 2; i >= 0; i--) {
                    fullScaleNotes.push(ascendingNotes[i]);
                }
                console.log(`DEBUG: Chromatic Scale Notes (${scaleName}):`, JSON.stringify(fullScaleNotes));

            } else if (type === 'arpeggio') {
                let arpeggioIntervals = originalString.includes("major arpeggio") ? [0, 4, 7] : [0, 3, 7];

                for (let o = 0; o < octaves; o++) {
                    for (let i = 0; i < arpeggioIntervals.length; i++) {
                        const midiNote = (arpeggioOrScaleRootIndex + arpeggioIntervals[i]) + (o * 12) + (baseOctave * 12);
                        ascendingNotes.push(Tone.Midi(midiNote).toNote());
                    }
                }
                const topOctaveRootMidi = (arpeggioOrScaleRootIndex) + (octaves * 12) + (baseOctave * 12);
                ascendingNotes.push(Tone.Midi(topOctaveRootMidi).toNote());

                fullScaleNotes = [...ascendingNotes];
                for (let i = ascendingNotes.length - 2; i >= 0; i--) {
                    fullScaleNotes.push(ascendingNotes[i]);
                }

            } else if (type === 'dominant 7th') {
                const dominant7thIntervals = [0, 4, 7, 10]; // Root, M3, P5, m7

                let currentArpeggioRootMidi = arpeggioOrScaleRootIndex + (baseOctave * 12);

                for (let o = 0; o < octaves; o++) {
                    for (let i = 0; i < dominant7thIntervals.length; i++) {
                        ascendingNotes.push(Tone.Midi(currentArpeggioRootMidi + dominant7thIntervals[i]).toNote());
                    }
                    currentArpeggioRootMidi += 12;
                }
                ascendingNotes.push(Tone.Midi(arpeggioOrScaleRootIndex + (baseOctave * 12) + (octaves * 12)).toNote());


                fullScaleNotes = [...ascendingNotes];
                for (let i = ascendingNotes.length - 2; i >= 0; i--) {
                    fullScaleNotes.push(ascendingNotes[i]);
                }

                // The resolving tonic note (e.g., G for Dominant 7th in G) is added at the end.
                // Its octave should correspond to the top of the dominant 7th arpeggio or be sensible.
                // Assuming it resolves to the *next* octave of the tonic from the starting arpeggio.
                const resolvingTonicMidi = keyTonicIndexForDominant7th + (baseOctave * 12) + (octaves * 12); // Use the variable from higher scope
                fullScaleNotes.push(Tone.Midi(resolvingTonicMidi).toNote());

            } else if (type === 'diminished 7th') {
                const dim7Intervals = [0, 3, 6, 9]; // Root, m3, d5, d7

                let currentArpeggioRootMidi = arpeggioOrScaleRootIndex + (baseOctave * 12);

                for (let o = 0; o < octaves; o++) {
                    for (let i = 0; i < dim7Intervals.length; i++) {
                        const midiNote = currentArpeggioRootMidi + dim7Intervals[i];
                        ascendingNotes.push(Tone.Midi(midiNote).toNote());
                    }
                    currentArpeggioRootMidi += 12;
                }
                ascendingNotes.push(Tone.Midi(arpeggioOrScaleRootIndex + (baseOctave * 12) + (octaves * 12)).toNote());


                fullScaleNotes = [...ascendingNotes];
                for (let i = ascendingNotes.length - 2; i >= 0; i--) {
                    fullScaleNotes.push(ascendingNotes[i]);
                }
            }

            return fullScaleNotes;
        }

        /**
         * Toggles the demonstration playback. If playing, stops it. If not, starts it.
         */
        async function toggleDemonstration() {
            console.log("toggleDemonstration called. Initial AudioContext state:", Tone.context.state);

            if (Tone.context.state !== 'running') {
                try {
                    console.log("Attempting to start/resume AudioContext from toggleDemonstration...");
                    await Tone.start();
                    audioContextStarted = true;
                    console.log("AudioContext state after attempt:", Tone.context.state);
                    if (Tone.context.state !== 'running') {
                        throw new Error("AudioContext failed to transition to 'running' state.");
                    }
                } catch (e) {
                    console.error("Error starting/resuming AudioContext:", e);
                    scaleDisplay.textContent = "Error: Audio blocked! Click here or refresh and allow sound.";
                    scaleDisplay.classList.add('text-red-600');
                    return;
                }
            }

            if (Tone.context.state === 'running') {
                if (isPlayingDemo) {
                    console.log("Stopping current demo.");
                    if (currentSequence) {
                        currentSequence.stop();
                        currentSequence.dispose();
                        currentSequence = null;
                    }
                    Tone.Transport.stop();
                    isPlayingDemo = false;
                    demonstrationButton.textContent = "Play Demo";
                    demonstrationButton.disabled = false;
                    scaleDisplay.classList.remove('text-red-600');
                } else {
                    if (currentScaleSelected) {
                        scaleDisplay.classList.remove('text-red-600');
                        console.log("Preparing to play demo.");
                        const notesToPlay = getScaleNotes(currentScaleSelected);
                        const parsedScale = parseScaleName(currentScaleSelected);

                        // Added for debugging: Log the notes *before* they are sent to Tone.js
                        console.log(`DEBUG: Notes for "${currentScaleSelected}" (Tone.js format):`, JSON.stringify(notesToPlay));


                        if (notesToPlay.length === 0) {
                            console.warn("No notes to play for demonstration. This might be a parsing or generation error for:", currentScaleSelected);
                            scaleDisplay.textContent = `Error: No notes generated for "${currentScaleSelected}". Check console.`;
                            scaleDisplay.classList.add('text-red-600');
                            return;
                        }

                        console.log(`Playing demo for: ${currentScaleSelected}`, notesToPlay);
                        demonstrationButton.textContent = "Stop";
                        demonstrationButton.disabled = false;

                        const noteDuration = "4n"; // Quarter note duration
                        const noteDurationSeconds = Tone.Time(noteDuration).toSeconds();

                        // Clear any existing sequence or scheduled events before starting a new one
                        if (currentSequence) {
                            currentSequence.stop();
                            currentSequence.dispose();
                            currentSequence = null;
                        }
                        Tone.Transport.cancel(); // Cancel all scheduled events


                        // Check if it's a double-stop scale type and handle manually
                        if (parsedScale && (parsedScale.type === 'scale in 6ths' || parsedScale.type === 'tetrachord in octaves')) {
                            console.log("DEBUG: Handling double-stop scale with manual scheduling.");
                            let currentTime = 0;
                            notesToPlay.forEach((noteOrNotesArray, index) => {
                                // Schedule each chord (array of notes) at a specific time
                                Tone.Transport.scheduleOnce((time) => {
                                    console.log(`Playing chord: ${JSON.stringify(noteOrNotesArray)} at time: ${time}`);
                                    synth.triggerAttackRelease(noteOrNotesArray, noteDuration);
                                }, currentTime);
                                currentTime += noteDurationSeconds; // Advance time for the next note/chord
                            });

                            // Schedule the stopping of transport after all notes are played
                            Tone.Transport.scheduleOnce(() => {
                                console.log("Manual demo sequence finished naturally.");
                                if (isPlayingDemo) { // Only stop if still playing this demo
                                    toggleDemonstration();
                                }
                            }, currentTime); // currentTime now holds the end time of the last note

                            Tone.Transport.start();
                            isPlayingDemo = true;

                        } else {
                            console.log("DEBUG: Handling single-note scale with Tone.Sequence.");
                            // For single notes, use Tone.Sequence as it works reliably
                            currentSequence = new Tone.Sequence((time, noteOrNotesArray) => {
                                console.log("Playing note(s):", noteOrNotesArray, "at time:", time);
                                synth.triggerAttackRelease(noteOrNotesArray, noteDuration, time);
                            }, notesToPlay, noteDuration);

                            currentSequence.loop = false;
                            currentSequence.start(0);
                            Tone.Transport.start();
                            isPlayingDemo = true;

                            const totalDurationInSeconds = noteDurationSeconds * notesToPlay.length;

                            Tone.Transport.scheduleOnce(() => {
                                console.log("Tone.Sequence demo finished naturally.");
                                if (isPlayingDemo) {
                                    toggleDemonstration();
                                }
                            }, Math.max(Tone.Time("32n").toSeconds(), totalDurationInSeconds));
                        }

                    } else {
                        scaleDisplay.textContent = "Please select a scale first!";
                    }
                }
            } else {
                console.warn("AudioContext is not running, cannot play demo.");
                scaleDisplay.textContent = "Audio still blocked. Ensure site sound is enabled.";
                scaleDisplay.classList.add('text-red-600');
            }
        }

        /**
         * Calculates the average rating for a given scale.
         * Returns a default value (3) if no ratings exist, to avoid breaking sort.
         * @param {string} scaleName - The name of the scale.
         * @returns {number} The average rating (1-5) or 3 if no ratings.
         */
        function getAverageRating(scaleName) {
            const ratings = scaleRatings[scaleName];
            if (!ratings || ratings.length === 0) {
                return 3;
            }
            const sum = ratings.reduce((acc, rating) => acc + rating, 0);
            return sum / ratings.length;
        }

        /**
         * Renders (or re-renders) the list of all scales in the UI for the current grade.
         */
        function renderScalesList() {
            allScalesListContainer.innerHTML = '';

            currentAllScales.forEach(scale => {
                const scaleItem = document.createElement('div');
                const avgRating = getAverageRating(scale);
                const ratingText = scaleRatings[scale] && scaleRatings[scale].length > 0 ? `(Avg: ${avgRating.toFixed(1)}/5)` : '';

                scaleItem.textContent = `${scale} ${ratingText}`;
                scaleItem.classList.add(
                    'p-2', 'bg-white', 'rounded-md', 'shadow-sm',
                    'text-gray-700', 'text-left', 'text-base', 'sm:text-lg',
                    'font-medium', 'transition-all', 'duration-200',
                    'flex', 'justify-between', 'items-center'
                );

                const isUsedInCurrentRound = !availableScales.includes(scale) && !isPracticeMode;
                if (isUsedInCurrentRound) {
                    scaleItem.classList.add('greyed-out');
                } else if (isPracticeMode) {
                    scaleItem.classList.add('clickable-scale-item');
                    scaleItem.classList.remove('greyed-out');
                    scaleItem.onclick = () => selectPracticeScale(scale);
                } else {
                    scaleItem.classList.remove('clickable-scale-item');
                    scaleItem.onclick = null;
                }

                allScalesListContainer.appendChild(scaleItem);
            });
        }

        /**
         * Shows the congratulations modal with scales sorted by difficulty for the current grade.
         */
        function showCongratulationsPopup() {
            modalScalesList.innerHTML = '';

            const sortedScales = [...currentAllScales].sort((a, b) => {
                const ratingA = getAverageRating(a);
                const ratingB = getAverageRating(b);
                return ratingA - ratingB;
            });

            const ul = document.createElement('ul');
            ul.classList.add('list-disc', 'list-inside', 'space-y-1');

            sortedScales.forEach(scale => {
                const li = document.createElement('li');
                const avgRating = getAverageRating(scale);
                const ratingText = scaleRatings[scale] && scaleRatings[scale].length > 0 ? `(Avg: ${avgRating.toFixed(1)}/5)` : '(No ratings yet)';
                li.textContent = `${scale} ${ratingText}`;
                ul.appendChild(li);
            });
            modalScalesList.appendChild(ul);

            congratulationsModal.classList.remove('hidden');
        }

        /**
         * Hides the congratulations modal and resets the game state for a new random round.
         */
        function hideCongratulationsPopup() {
            congratulationsModal.classList.add('hidden');
            isFirstRandomRoundCompleted = true;
            resetRandomRound();
        }

        /**
         * Resets the available scales for a new random round for the current grade.
         */
        function resetRandomRound() {
            if (isFirstRandomRoundCompleted) {
                availableScales = [...currentAllScales].sort((a, b) => {
                    const ratingA = getAverageRating(a);
                    const ratingB = getAverageRating(b);
                    return ratingA - ratingB;
                });
                console.log("Scales sorted for next random round based on ratings:", availableScales);
            } else {
                availableScales = [...currentAllScales];
            }
            renderScalesList();
        }

        /**
         * Selects a random scale from the availableScales array for random mode.
         * @returns {string|null} The chosen scale name, or null if all scales are done.
         */
        function selectRandomScale() {
            if (availableScales.length === 0) {
                showCongratulationsPopup();
                return null;
            }

            let randomIndex;
            let chosenScale;

            do {
                randomIndex = Math.floor(Math.random() * availableScales.length);
                chosenScale = availableScales[randomIndex];
            } while (chosenScale === previousScale && availableScales.length > 1);

            availableScales.splice(randomIndex, 1);
            previousScale = chosenScale;
            return chosenScale;
        }

        /**
         * Handles selecting a scale when in practice mode.
         * @param {string} scaleName - The name of the scale clicked.
         */
        function selectPracticeScale(scaleName) {
            if (isPlayingDemo) {
                toggleDemonstration();
            }

            scaleDisplay.textContent = scaleName;
            currentScaleSelected = scaleName;

            gimmeScaleButton.classList.add('hidden');
            actionContainer.classList.remove('hidden');
            demonstrationButton.textContent = "Play Demo";
            stars.forEach(star => star.classList.remove('selected'));

            scaleDisplay.classList.remove('animate-pulse');
            void scaleDisplay.offsetWidth;
            scaleDisplay.classList.add('animate-pulse');
            setTimeout(() => {
                scaleDisplay.classList.remove('animate-pulse');
            }, 500);
        }

        // --- New Grade Selection Logic ---
        function selectGrade(grade) {
            currentGrade = grade;
            // Corrected: Display grade number only, not "Grade Grade X"
            mainTitle.textContent = `Grade ${grade.replace('Grade ', '')} Scale Practice App`;
            currentAllScales = allGradeScales[grade];

            // Reset ratings and available scales for the new grade
            scaleRatings = {};
            currentAllScales.forEach(scale => {
                scaleRatings[scale] = [];
            });
            availableScales = [...currentAllScales];
            previousScale = null;
            isFirstRandomRoundCompleted = false;
            currentScaleSelected = null;
            scaleDisplay.textContent = "Click 'Gimme a Scale!' to start!";
            actionContainer.classList.add('hidden');
            gimmeScaleButton.classList.remove('hidden');
            isPracticeMode = false; // Reset to random mode when changing grades

            gradeSelectionScreen.classList.add('hidden');
            practiceScreen.classList.remove('hidden');
            practiceScreen.style.display = 'flex'; // Ensure flex layout

            renderScalesList(); // Render scales for the newly selected grade
        }

        function createGradeButtons() {
            for (let i = 1; i <= 8; i++) {
                const button = document.createElement('button');
                button.textContent = `Grade ${i}`;
                button.classList.add(
                    'bg-blue-500', 'hover:bg-blue-600', 'text-white', 'font-bold',
                    'py-3', 'px-6', 'rounded-full', 'shadow-lg', 'hover:shadow-xl',
                    'transition', 'duration-300', 'ease-in-out', 'transform', 'hover:-translate-y-1',
                    'focus:outline-none', 'focus:ring-4', 'focus:ring-blue-300', 'focus:ring-opacity-75',
                    'text-xl'
                );
                button.onclick = () => selectGrade(`Grade ${i}`);
                gradeButtonsContainer.appendChild(button);
            }
        }

        // --- Event Listeners ---

        gimmeScaleButton.addEventListener('click', () => {
            console.log("Gimme Scale button clicked!");
            if (isPlayingDemo) {
                toggleDemonstration();
            }

            const scale = selectRandomScale();
            if (scale) {
                scaleDisplay.textContent = scale;
                currentScaleSelected = scale;

                gimmeScaleButton.classList.add('hidden');
                actionContainer.classList.remove('hidden');
                demonstrationButton.textContent = "Play Demo";
                stars.forEach(star => star.classList.remove('selected'));

                scaleDisplay.classList.remove('animate-pulse');
                void scaleDisplay.offsetWidth;
                scaleDisplay.classList.add('animate-pulse');
                setTimeout(() => {
                    scaleDisplay.classList.remove('animate-pulse');
                }, 500);
            }
        });

        togglePracticeModeButton.addEventListener('click', async () => {
            console.log("Toggle Practice Mode button clicked!");
            if (isPlayingDemo) {
                toggleDemonstration();
            }

            if (Tone.context.state !== 'running') {
                try {
                    console.log("Attempting to start/resume AudioContext from Toggle Practice Mode...");
                    await Tone.start();
                    audioContextStarted = true;
                    console.log("AudioContext state after Toggle Practice Mode attempt:", Tone.context.state);
                } catch (e) {
                    console.error("Error starting/resuming AudioContext from Toggle Practice Mode:", e);
                    scaleDisplay.textContent = "Audio blocked! Please ensure sound is allowed for this site.";
                    scaleDisplay.classList.add('text-red-600');
                }
            }

            isPracticeMode = !isPracticeMode;
            if (isPracticeMode) {
                gimmeScaleButton.classList.add('hidden');
                actionContainer.classList.add('hidden');
                scaleDisplay.textContent = "Select a scale from the list below!";
            } else {
                gimmeScaleButton.classList.remove('hidden');
                scaleDisplay.textContent = "Click 'Gimme a Scale!' to start!";
            }
            renderScalesList();
        });

        demonstrationButton.addEventListener('click', toggleDemonstration);

        // Slider event listener to update BPM
        bpmSlider.addEventListener('input', () => {
            Tone.Transport.bpm.value = bpmSlider.value;
            bpmValueDisplay.textContent = bpmSlider.value;
            console.log("BPM set to:", bpmSlider.value);
        });

        // Volume Slider Logic
        volumeSlider.addEventListener('input', () => {
            const sliderValue = parseInt(volumeSlider.value);
            volumeValueDisplay.textContent = sliderValue; // Display percentage

            if (sliderValue === 0) {
                Tone.Destination.volume.value = -Infinity; // Mute
            } else {
                // Map the 0-100 linear slider value to a -60dB to 0dB range.
                // This gives a perception of more linear volume change.
                // -60dB is often considered "silent" in practical audio applications.
                const minDb = -60;
                const maxDb = 0;
                // Calculate dB value: (sliderValue / 100) * (maxDb - minDb) + minDb
                const dbValue = (sliderValue / 100) * (maxDb - minDb) + minDb;
                Tone.Destination.volume.value = dbValue;
            }
            console.log("Volume set to:", sliderValue, "%, calculated dB:", Tone.Destination.volume.value);
        });


        stars.forEach(star => {
            star.addEventListener('mouseover', () => {
                const value = parseInt(star.dataset.value);
                stars.forEach((s, i) => {
                    if (i < value) {
                        s.classList.add('hovered');
                    } else {
                        s.classList.remove('hovered');
                    }
                });
            });

            star.addEventListener('mouseout', () => {
                stars.forEach(s => s.classList.remove('hovered'));
            });

            star.addEventListener('click', () => {
                const rating = parseInt(star.dataset.value);

                stars.forEach((s, i) => {
                    if (i < rating) {
                        s.classList.add('selected');
                    } else {
                        s.classList.remove('selected');
                    }
                });

                if (currentScaleSelected && scaleRatings[currentScaleSelected]) {
                    scaleRatings[currentScaleSelected].push(rating);
                    console.log(`Rated "${currentScaleSelected}" as ${rating} stars. All ratings:`, scaleRatings);
                }

                renderScalesList();

                if (isPlayingDemo) {
                    toggleDemonstration();
                }

                setTimeout(() => {
                    actionContainer.classList.add('hidden');
                    if (!isPracticeMode) {
                        gimmeScaleButton.classList.remove('hidden');
                    }
                }, 700);
            });
        });

        closeModalButton.addEventListener('click', hideCongratulationsPopup);

        backToGradesButton.addEventListener('click', () => {
            if (isPlayingDemo) { // Stop any ongoing demo
                toggleDemonstration();
            }
            practiceScreen.classList.add('hidden');
            gradeSelectionScreen.classList.remove('hidden');
            // When going back to grade selection, reset main title to the app's name
            mainTitle.textContent = "Elliot's Scale Practice App for MTB Viola Exams";
        });


        // --- Initial Load Logic ---
        window.onload = () => {
            createGradeButtons(); // Populate grade selection buttons
            bpmValueDisplay.textContent = bpmSlider.value; // Set initial BPM display
            volumeValueDisplay.textContent = volumeSlider.value; // Set initial volume display (percentage)
            // The app starts on the grade selection screen, practiceScreen is hidden by default.
            console.log("App loaded. Version: 2024-06-13-23-30"); // Unique version identifier
        };
    </script>
</body>
</html>
